<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="referrer" content="no-referrer" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AI RSS Reader Pro</title>
<!-- å¼•å…¥ FontAwesome -->
<link rel="stylesheet" href="../../fontawesome/css/all.min.css">
<!-- [Lib] å¼•å…¥ markdown-it æ ¸å¿ƒåº“ -->
<script src="../../libs/markdown-it.min.js"></script>
<!-- [Lib] å¼•å…¥ markdown-it-container æ’ä»¶ (ç”¨äºæ”¯æŒ ::: tip è¯­æ³•) -->
<script src="../../libs/markdown-it-container.min.js"></script>
<style>
/* ================== åŸºç¡€æ ·å¼ ================== */
:root {
  --bg-sidebar: #f9f9f9; --bg-list: #fff; --bg-content: #fff;
  --border: #e0e0e0; --text-main: #333; --text-sub: #666;
  --accent: #ff6b35; --hover: #f0f0f0; --header-h: 54px;
  --ai-summary-bg: #f8fbff; --ai-summary-border: #dbeafe;
  --ai-text-color: #1e3a8a;
  /* Admonition Colors */
  --admonition-tip-border: #42b983;
  --admonition-tip-bg: #f3f5f7;
  --admonition-warning-border: #e7c000;
  --admonition-warning-bg: #fff7d0;
  --admonition-danger-border: #c00;
  --admonition-danger-bg: #ffe6e6;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
body { height: 100vh; display: flex; overflow: hidden; color: var(--text-main); background: #fff; }
/* å¸ƒå±€ */
.layout-col { height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
#sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); flex-shrink: 0; z-index: 3; }
#articleList { width: 350px; background: var(--bg-list); border-right: 1px solid var(--border); flex-shrink: 0; z-index: 2; }
#contentView { flex: 1; background: var(--bg-content); position: relative; z-index: 1; scroll-behavior: smooth; }
/* é¡¶éƒ¨æ  */
.header-bar {
height: var(--header-h); padding: 0 15px; border-bottom: 1px solid var(--border);
display: flex; align-items: center; justify-content: space-between;
background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
position: sticky; top: 0; z-index: 10; font-weight: 600; font-size: 15px; flex-shrink: 0; 
}
/* Tooltip æ ·å¼ (æ—  Title å±æ€§) */
[data-tooltip] { position: relative; }
[data-tooltip]::after {
  content: attr(data-tooltip-text);
  position: absolute;
  bottom: -34px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.8); color: #fff;
  padding: 5px 10px; border-radius: 4px; font-size: 12px;
  white-space: nowrap; pointer-events: none; opacity: 0;
  transition: opacity 0.2s; z-index: 1000; font-weight: normal;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
[data-tooltip]:hover::after { opacity: 1; }
.bottom-tooltip[data-tooltip]::after { bottom: auto; top: -34px; }
.btn-icon { background: none; border: none; cursor: pointer; color: var(--text-sub); font-size: 16px; padding: 8px; border-radius: 6px; transition: .2s; display: flex; align-items: center; justify-content: center;}
.btn-icon:hover { color: var(--accent); background: rgba(0,0,0,0.05); }
/* æ“ä½œæ æŒ‰é’®ç»„ */
.toolbar-group { display: flex; gap: 8px; align-items: center; }
.btn-toolbar {
  display: flex; align-items: center; gap: 6px;
  background: #f0f0f0; border: 1px solid transparent;
  padding: 6px 12px; border-radius: 20px;
  font-size: 13px; color: #444; cursor: pointer; transition: all .2s;
}
.btn-toolbar:hover { background: #e5e5e5; color: #000; }
.btn-toolbar.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-toolbar:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
.btn-toolbar i { font-size: 14px; }
/* è®¢é˜…åˆ—è¡¨é¡¹ */
.feed-item {
padding: 10px 12px; margin: 4px 10px; border-radius: 6px; cursor: pointer;
display: flex; align-items: center; gap: 10px; font-size: 14px; position: relative;
transition: background .2s;
}
.feed-item:hover { background: rgba(0,0,0,0.05); }
.feed-item.active { background: #e6e6e6; font-weight: 600; }
.feed-icon { width: 16px; height: 16px; border-radius: 3px; object-fit: cover; flex-shrink: 0; }
.feed-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 20px; }
.btn-delete {
position: absolute; right: 5px; opacity: 0; color: #999; border:none;
background:none; cursor:pointer; padding: 4px; transition: opacity .2s; z-index: 2;
}
.feed-item:hover .btn-delete { opacity: 1; }
.btn-delete:hover { color: #ff4d4f; }
.icon-locked { position: absolute; right: 8px; color: #ccc; font-size: 12px; opacity: 0.5; }
/* æ–‡ç« å¡ç‰‡ */
.article-card { padding: 18px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .2s; }
.article-card:hover { background: var(--hover); }
.article-card.active { border-left: 4px solid var(--accent); background: var(--hover); padding-left: 16px; }
.article-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; line-height: 1.4; color: #222; }
.article-meta { font-size: 12px; color: var(--text-sub); display: flex; justify-content: space-between; }
.article-img-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; margin-top: 8px; display: none; }
.article-card.has-img .article-img-preview { display: block; }
/* æ–‡ç« è¯¦æƒ… */
.article-scroll-area { padding: 30px 40px; height: calc(100% - var(--header-h)); overflow-y: auto; }
#articleHeader { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
#articleHeader h1 { font-size: 24px; margin-bottom: 10px; line-height: 1.4; color: #111; transition: color 0.3s; }
#articleBody { font-size: 17px; line-height: 1.8; color: #333; overflow-wrap: break-word; }
#articleBody img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; display: block; }
#articleBody a { color: var(--accent); text-decoration: none; border-bottom: 1px dashed var(--accent); }
#placeholder { height: 100%; display: flex; align-items: center; justify-content: center; color: #999; flex-direction: column; gap: 15px; }
/* ================== æ·±åº¦ä¼˜åŒ–çš„ Markdown æ¸²æŸ“æ ·å¼ ================== */

#articleBody {
  font-size: 17px;
  line-height: 1.85;
  color: #374151; /* æ›´æŸ”å’Œçš„æ·±ç°è‰² */
  word-break: break-word;
  letter-spacing: 0.01em;
}

/* --- æ ‡é¢˜å±‚çº§ (Headings) --- */
#articleBody h1, #articleBody h2, #articleBody h3, 
#articleBody h4, #articleBody h5, #articleBody h6 {
  color: #111827;
  margin-top: 1.5em;
  margin-bottom: 0.8em;
  font-weight: 700;
  line-height: 1.3;
}

#articleBody h1 { font-size: 1.8em; border-bottom: 2px solid #f3f4f6; padding-bottom: 0.3em; }
#articleBody h2 { font-size: 1.5em; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.3em; }
#articleBody h3 { font-size: 1.25em; }
#articleBody h4 { font-size: 1.1em; }

/* --- æ®µè½ä¸é—´è· --- */
#articleBody p {
  margin-bottom: 1.2em;
}

/* --- å¼•ç”¨ (Blockquotes) --- */
#articleBody blockquote {
  margin: 1.5em 0;
  padding: 0.8em 1.2em;
  color: #4b5563;
  background-color: #f9fafb;
  border-left: 4px solid var(--accent);
  border-radius: 0 4px 4px 0;
  font-style: italic;
}
#articleBody blockquote p { margin-bottom: 0; }

/* --- åˆ—è¡¨ (Lists) --- */
#articleBody ul, #articleBody ol {
  margin-bottom: 1.2em;
  padding-left: 1.5em;
}
#articleBody li {
  margin-bottom: 0.5em;
}
#articleBody li > ul, #articleBody li > ol {
  margin-top: 0.5em;
  margin-bottom: 0;
}

/* --- ä»£ç å— (Code) --- */
/* è¡Œå†…ä»£ç  */
#articleBody code {
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
  background-color: rgba(255, 107, 53, 0.08);
  color: var(--accent);
  padding: 0.2em 0.4em;
  border-radius: 4px;
  font-size: 0.9em;
}

/* å—çŠ¶ä»£ç  */
#articleBody pre {
  background-color: #1f2937;
  color: #f9fafb;
  padding: 1.2em;
  border-radius: 8px;
  overflow-x: auto;
  margin-bottom: 1.5em;
  line-height: 1.5;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
}
#articleBody pre code {
  background: none;
  color: inherit;
  padding: 0;
  font-size: 0.85em;
}

/* --- è¡¨æ ¼ (Tables) - ç°ä»£ç®€çº¦é£ --- */
#articleBody table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-bottom: 1.5em;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
}
#articleBody th {
  background-color: #f8fafc;
  font-weight: 600;
  text-align: left;
  color: #475569;
}
#articleBody th, #articleBody td {
  padding: 10px 14px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 0.95em;
}
#articleBody tr:last-child td {
  border-bottom: none;
}
#articleBody tr:hover td {
  background-color: #fdfaff; /* æ‚¬åœæ•ˆæœ */
}

/* --- åˆ†å‰²çº¿ (Horizontal Rule) --- */
#articleBody hr {
  height: 2px;
  background-color: #f3f4f6;
  border: none;
  margin: 2em 0;
  position: relative;
}
#articleBody hr::after {
  content: "âœ¦";
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 0 10px;
  color: #d1d5db;
  font-size: 14px;
}

/* --- å›¾ç‰‡å¤„ç† (Images) --- */
#articleBody img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1.5em auto;
  display: block;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  transition: transform 0.3s;
}
#articleBody img:hover {
  transform: scale(1.01);
}

/* --- é“¾æ¥æ ·å¼ --- */
#articleBody a {
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1.5px solid rgba(255, 107, 53, 0.2);
  transition: all 0.2s;
}
#articleBody a:hover {
  background-color: rgba(255, 107, 53, 0.05);
  border-bottom-color: var(--accent);
}

/* --- [ä¿®æ­£] è­¦å‘Š/æç¤ºæ¡†æ¸²æŸ“å¢å¼º (Admonitions) --- */
.admonition {
  border-left-width: 6px !important;
  border-radius: 6px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.admonition-title {
  font-size: 0.85rem !important;
  display: flex !important;
  align-items: center;
  gap: 6px;
}
.admonition.tip::before { content: "ğŸ’¡"; float: left; margin-right: 8px; }
.admonition.warning::before { content: "âš ï¸"; float: left; margin-right: 8px; }
.admonition.danger::before { content: "ğŸš«"; float: left; margin-right: 8px; }

/* --- AI æ€»ç»“åŒºåŸŸçš„ Markdown å¾®è°ƒ --- */
#aiSummaryContent {
  font-size: 14.5px;
  color: #1e3a8a;
}
#aiSummaryContent ul {
  list-style: none;
  padding-left: 5px;
}
#aiSummaryContent li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 8px;
}
#aiSummaryContent li::before {
  content: "â€¢";
  color: var(--accent);
  font-weight: bold;
  position: absolute;
  left: 0;
}
/* AI æ€»ç»“åŒºåŸŸ */
#aiSummarySection {
  background: var(--ai-summary-bg);
  border: 1px solid var(--ai-summary-border);
  border-radius: 8px;
  padding: 18px;
  margin-bottom: 25px;
  display: none;
  font-size: 15px;
  color: var(--ai-text-color);
  line-height: 1.6;
}
#aiSummarySection .summary-header {
  font-weight: bold; margin-bottom: 10px; font-size: 14px; 
  display: flex; gap: 8px; align-items: center; color: var(--accent);
}
#aiSummaryContent ul, #aiSummaryContent ol { margin-left: 20px; margin-bottom: 10px; }
#aiSummaryContent p { margin-bottom: 10px; }
#aiSummaryContent strong { color: #000; }
/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 1280px) {
body { position: relative; }
.layout-col { position: absolute; inset: 0; width: 100%; background: #fff; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: translateX(100%); }
body[data-view="sidebar"] #sidebar { transform: translateX(0); z-index: 30; }
body[data-view="list"] #articleList { transform: translateX(0); z-index: 40; }
body[data-view="content"] #contentView { transform: translateX(0); z-index: 50; }
#sidebar, #articleList, #contentView { width: 100%; border: none; }
.article-scroll-area { padding: 20px; }
.btn-delete { opacity: 1; }
.mobile-hide { display: none; }
.mobile-show { display: inline-block; }
.toolbar-group { gap: 5px; }
.btn-toolbar { padding: 6px 10px; font-size: 12px; }
.btn-toolbar span { display: none; } 
}
@media (min-width: 769px) { .mobile-show { display: none; } }
/* æ¨¡æ€æ¡†é€šç”¨ */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal.active { display: flex; }
.modal-box { background: #fff; width: 90%; max-width: 420px; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column; }
.modal-header { font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; font-size: 18px; flex-shrink: 0; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: #666; }
.form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; background: #fafafa; }
/* ä¿®å¤ Select ç®­å¤´ä½ç½® */
.form-group select {
  width: 100%;
  padding: 10px 30px 10px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  outline: none;
  background-color: #fafafa;
  cursor: pointer;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 10px auto;
}
.form-group input:focus { border-color: var(--accent); background: #fff; }
.btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-ghost { background: #eee; color: #333; }
.tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.tag-btn { font-size: 12px; padding: 4px 8px; background: #eee; border-radius: 4px; cursor: pointer; color: #555; }
.tag-btn:hover { background: #e0e0e0; color: #000; }
/* æ¢ç´¢å™¨æ¨¡æ€æ¡†ç‰¹æœ‰æ ·å¼ */
.explorer-container { display: flex; border: 1px solid #eee; height: 400px; border-radius: 6px; overflow: hidden; }
.explorer-side { width: 35%; border-right: 1px solid #eee; background: #f9f9f9; overflow-y: auto; }
.explorer-main { flex: 1; background: #fff; overflow-y: auto; position: relative; }
.ns-item { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f0f0f0; transition: .2s; }
.ns-item:hover { background: #eee; }
.ns-item.active { background: #e6e6e6; color: var(--accent); font-weight: bold; border-left: 3px solid var(--accent); }
.ns-item.special-item { background: #fff8f0; color: #d35400; font-weight: 600; border-bottom: 1px dashed #e0e0e0; }
.ns-item.special-item:hover { background: #ffe0d0; }
.ns-item.special-item.active { background: #ffebd9; border-left-color: #d35400; }
/* è·¯ç”±åˆ—è¡¨ä¸è¯¦æƒ…æ ·å¼ */
.route-item { 
  padding: 10px 12px; 
  cursor: pointer; 
  font-size: 13px; 
  border-bottom: 1px solid #f0f0f0; 
  transition: .2s; 
  display: flex; 
  flex-direction: column;
}
.route-item:hover { background: #f9f9f9; }
.route-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.route-title { font-weight: 600; color: #333; }
.route-path-preview { color: #888; font-size: 12px; margin-top: 4px; font-family: monospace; }
.route-details { 
  display: none; 
  margin-top: 10px; 
  padding-top: 10px; 
  border-top: 1px dashed #eee; 
  font-size: 12px; 
  color: #555; 
  cursor: default; 
}
.route-item.expanded { background: #f0f8ff; border-left: 3px solid var(--accent); }
.route-item.expanded .route-details { display: block; }
.featured-group-title {
  padding: 10px 12px;
  background: #f1f1f1;
  font-weight: bold;
  font-size: 12px;
  color: #666;
  border-bottom: 1px solid #e0e0e0;
  position: sticky;
  top: 0;
  z-index: 5;
}
/* Markdown æ¸²æŸ“æ ·å¼ */
.md-content { font-size: 13px; line-height: 1.5; color: #444; margin-bottom: 10px; }
.md-content table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 12px; background: #fff; }
.md-content th, .md-content td { border: 1px solid #e0e0e0; padding: 6px 10px; }
.md-content th { background: #f9f9f9; font-weight: 600; text-align: left; }
.md-content a { color: var(--accent); text-decoration: none; border-bottom: 1px dashed var(--accent); }
.md-content code { background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 12px; color: #d63384; }
.md-content p { margin-bottom: 8px; }
/* [New] Admonition (::: tip) æ ·å¼ */
.admonition { margin: 10px 0; padding: 12px 16px; border-left: 4px solid #ccc; background-color: #fafafa; border-radius: 4px; }
.admonition .admonition-title { font-weight: bold; margin-bottom: 6px; display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
/* Tip */
.admonition.tip { border-color: var(--admonition-tip-border); background-color: var(--admonition-tip-bg); }
.admonition.tip .admonition-title { color: #2c3e50; }
/* Warning */
.admonition.warning { border-color: var(--admonition-warning-border); background-color: var(--admonition-warning-bg); }
.admonition.warning .admonition-title { color: #6b5900; }
/* Danger */
.admonition.danger { border-color: var(--admonition-danger-border); background-color: var(--admonition-danger-bg); }
.admonition.danger .admonition-title { color: #900; }
/* å‚æ•°è¡¨æ ¼æ ·å¼ */
.param-table { width: 100%; border-collapse: collapse; margin: 8px 0; background: #fff; border: 1px solid #eee; }
.param-table th, .param-table td { border: 1px solid #eee; padding: 6px; text-align: left; vertical-align: top; }
.param-table th { background: #fafafa; font-weight: 600; width: 30%; color: #444; }
.param-badge { display: inline-block; background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 11px; margin-right: 5px; }
.use-btn { 
  background: var(--accent); color: #fff; border: none; 
  padding: 6px 12px; border-radius: 4px; cursor: pointer; 
  font-size: 12px; margin-top: 8px; float: right; 
}
.use-btn:hover { opacity: 0.9; }
/* æ‚¬æµ®å·¥å…·ä¸ Loading */
#selectionToolbar { position: fixed; display: none; z-index: 2000; background: #222; color: #fff; border-radius: 6px; padding: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
#selectionToolbar button { background: none; border: none; color: #fff; padding: 4px 10px; cursor: pointer; display: flex; gap: 6px; align-items: center; font-size: 13px; }
#translatePopup { position: fixed; display: none; z-index: 2001; background: #fff; width: 300px; max-height: 300px; overflow-y: auto; padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); font-size: 14px; border: 1px solid #eee; }
.spinner { width: 24px; height: 24px; border: 3px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.cache-badge { font-size: 12px; color: #aaa; margin-left: 5px; font-weight: normal; display: inline-flex; align-items: center; gap: 4px; }
/* ================== æ–°å¢ï¼šç¿»è¯‘æ ·å¼ ================== */
[data-translating="true"] {
  position: relative;
  /* å…³é”®ä¿®å¤ï¼šå¸ƒå±€éš”ç¦»ï¼Œå‘Šè¯‰æµè§ˆå™¨è¯¥å…ƒç´ çš„å¸ƒå±€å˜åŒ–ä¸ä¼šå½±å“å¤–éƒ¨ */
  contain: layout style paint; 
  border-left: 3px solid var(--accent); 
  padding-left: 12px; 
  margin-left: -15px;
  transition: all 0.3s ease;
  /* ä¼˜åŒ–æ–‡æœ¬æ¸²æŸ“é€Ÿåº¦ */
  text-rendering: optimizeSpeed; 
}
/* ç¿»è¯‘å®Œæˆåç§»é™¤ç‰¹æ®Šæ ·å¼ */
[data-translated="true"] {
  border-left: 3px solid transparent;
  padding-left: 12px;
  margin-left: -15px;
  /* ç¿»è¯‘å®Œæˆåç§»é™¤ contain ä»¥æ¢å¤æ­£å¸¸æµäº¤äº’ï¼ˆå¦‚å¤åˆ¶é€‰åŒºç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥ä¿ç•™ */
  contain: none; 
}
/* ç¿»è¯‘è¿‡ç¨‹ä¸­çš„å¾®åŠ¨ç”» */
@keyframes translate-pulse {
  0% { border-left-color: rgba(255, 107, 53, 0.4); }
  50% { border-left-color: rgba(255, 107, 53, 1); }
  100% { border-left-color: rgba(255, 107, 53, 0.4); }
}
[data-translating="true"] {
  animation: translate-pulse 1.5s infinite;
}
/* æ·¡å…¥æ•ˆæœ */
.trans-fade-in {
  animation: fadeIn 0.5s ease-out forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(2px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ================== [æ–°å¢] è§†å›¾åˆ‡æ¢ä¸‹æ‹‰èœå•æ ·å¼ ================== */
.dropdown-menu {
  display: none; position: absolute; top: 100%; left: 0;
  background: #fff; border: 1px solid #eee; border-radius: 6px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 5px; z-index: 100;
  min-width: 140px; animation: fadeIn 0.2s;
}
.dropdown-menu.show { display: block; }
.dropdown-item {
  padding: 8px 12px; font-size: 13px; cursor: pointer;
  border-radius: 4px; display: flex; align-items: center; gap: 8px; color: #555;
}
.dropdown-item:hover { background: #f5f5f5; color: #000; }
.dropdown-item.active { background: #e6f7ff; color: var(--accent); }
.dropdown-item i { width: 16px; text-align: center; }

/* ================== [æ–°å¢] æ–‡ç« è§†å›¾æ¨¡å¼æ ·å¼ ================== */

/* --- é€šç”¨é‡ç½® --- */
#articleContent {
  transition: max-width 0.3s ease;
  margin: 0 auto;
}

/* --- 1. åšå®¢æ¨¡å¼ (Blog View) --- */
/* ä¸“æ³¨äºæ’ç‰ˆã€é˜…è¯»ä½“éªŒï¼Œç±»ä¼¼ Medium/çŸ¥ä¹ä¸“æ  */
#articleContent.view-blog {
  max-width: 720px; /* é™åˆ¶å®½åº¦ä»¥æå‡é˜…è¯»ä½“éªŒ */
}
#articleContent.view-blog #articleHeader h1 {
  font-family: "Georgia", "Source Han Serif CN", "Songti SC", serif; /* è¡¬çº¿ä½“æ ‡é¢˜ */
  font-weight: 700;
  font-size: 28px;
  letter-spacing: -0.5px;
}
#articleContent.view-blog #articleBody {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
  font-size: 18px; /* æ›´å¤§çš„å­—å· */
  line-height: 1.8; /* æ›´å®½æ¾çš„è¡Œé«˜ */
  color: #2c3e50;
}
#articleContent.view-blog #articleBody p { margin-bottom: 24px; }
#articleContent.view-blog #articleBody img,
#articleContent.view-blog #articleBody video,
#articleContent.view-blog #articleBody iframe {
  max-width: 100%; height: auto; display: block; margin: 20px auto;
  border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
#articleContent.view-blog blockquote {
  border-left: 4px solid var(--accent);
  padding-left: 16px; margin: 20px 0; color: #666; font-style: italic; background: #fafafa; padding: 10px 16px;
}

/* --- 2. ç”»å»Šæ¨¡å¼ (Gallery View) --- */
/* ä¸“æ³¨äºå›¾ç‰‡å±•ç¤ºï¼Œç€‘å¸ƒæµå¸ƒå±€ */
#articleContent.view-gallery {
  max-width: 100%; /* å…¨å®½ */
  padding: 0 10px;
}
#articleContent.view-gallery #articleHeader {
  text-align: center; max-width: 800px; margin: 0 auto 30px auto;
}
#articleContent.view-gallery #aiSummarySection {
  max-width: 800px; margin: 0 auto 20px auto;
}
/* ä½¿ç”¨ CSS Columns å®ç°ç€‘å¸ƒæµï¼Œå› ä¸ºå®ƒèƒ½å¾ˆå¥½åœ°å¤„ç†ä¸åŒé«˜åº¦çš„å›¾ç‰‡ */
#articleContent.view-gallery #articleBody {
  column-count: 3; /* æ¡Œé¢ç«¯ 3 åˆ— */
  column-gap: 15px;
  font-size: 14px;
}
/* æ¯ä¸€å—å†…å®¹ï¼ˆæ®µè½æˆ–å›¾ç‰‡å®¹å™¨ï¼‰é¿å…åœ¨ä¸­é—´æ–­å¼€ */
#articleContent.view-gallery #articleBody > * {
  break-inside: avoid;
  margin-bottom: 15px;
  background: #fff;
  border-radius: 8px;
  /* å¯é€‰ï¼šç»™æ¯ä¸ªå—åŠ ä¸€ç‚¹å¡ç‰‡æ•ˆæœ */
  /* border: 1px solid #f0f0f0; padding: 10px; */ 
}
#articleContent.view-gallery #articleBody img,
#articleContent.view-gallery #articleBody video,
#articleContent.view-gallery #articleBody iframe {
  width: 100%; height: auto;
  border-radius: 6px;
  display: block;
}
/* åœ¨ç”»å»Šæ¨¡å¼ä¸‹ï¼Œå¼±åŒ–çº¯æ–‡æœ¬æ®µè½ï¼Œæˆ–è€…è®©å®ƒåƒå›¾ç‰‡è¯´æ˜ */
#articleContent.view-gallery #articleBody p {
  color: #666; line-height: 1.5; margin-top: 5px;
}

/* ç§»åŠ¨ç«¯é€‚é…ç”»å»Šæ¨¡å¼ */
@media (max-width: 1280px) {
  #articleContent.view-gallery #articleBody { column-count: 2; }
}
@media (max-width: 480px) {
  #articleContent.view-gallery #articleBody { column-count: 1; }
}
/* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®çš„ Hover æ•ˆæœ */
label.btn-ghost:hover {
  background-color: #f0f0f0;
  border-color: var(--accent) !important;
  color: var(--accent);
  cursor: pointer;
}
/* ================== [æ–°å¢] ä¾§è¾¹æ æœç´¢æ¡†æ ·å¼ ================== */
.sidebar-search {
  padding: 10px 12px;
  background: #f9f9f9; /* ä¸ä¾§è¾¹æ èƒŒæ™¯ä¸€è‡´ */
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  position: sticky; /* å…³é”®ï¼šå¸é¡¶æ•ˆæœ */
  top: var(--header-h); /* ç´§è´´ Header ä¸‹æ–¹ */
  z-index: 5;
}
.sidebar-search i {
  color: #999;
  font-size: 13px;
}
.sidebar-search input {
  flex: 1;
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  padding: 6px 8px;
  font-size: 13px;
  outline: none;
  transition: all 0.2s;
}
.sidebar-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}
/* ================== [æ–°å¢] RSS ç«™ç‚¹å¡ç‰‡æ ·å¼ ================== */
.rss-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* è‡ªé€‚åº”ç½‘æ ¼ */
  gap: 15px;
  overflow-y: auto;
  padding: 2px; /* é˜²æ­¢é˜´å½±è¢«åˆ‡ */
  flex: 1; /* å æ»¡æ¨¡æ€æ¡†å‰©ä½™é«˜åº¦ */
  align-content: start;       /* è®©å¡ç‰‡ä»é¡¶éƒ¨å¼€å§‹æ’åˆ—ï¼Œä¸è¦åˆ†æ•£æ‹‰ä¼¸ */
  grid-auto-rows: max-content; /* è®©æ¯ä¸€è¡Œçš„é«˜åº¦æ ¹æ®å†…å®¹è‡ªé€‚åº”ï¼Œä¸è¦å¼ºåˆ¶æ’‘é«˜ */
}

.rss-card {
  background: #fff;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  transition: all 0.2s;
  cursor: default;
}

.rss-card:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transform: translateY(-2px);
}

.rss-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.rss-card-title {
  font-weight: 600;
  font-size: 14px;
  color: #333;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.rss-card-tag {
  font-size: 10px;
  background: #f0f0f0;
  color: #666;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: auto; /* æ¨åˆ°å³è¾¹ */
}

.rss-card-desc {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
  margin-bottom: 12px;
  flex: 1; /* è®©æè¿°å æ®å‰©ä½™ç©ºé—´ï¼Œä¿è¯æŒ‰é’®å¯¹é½ */
  display: -webkit-box;
  -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.rss-card-btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: opacity 0.2s;
}

.rss-card-btn:hover {
  opacity: 0.9;
}
/* æ‚å¿—å¡ç‰‡æ ·å¼ */
.mag-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px;
  transition: all .2s; cursor: pointer;
}
.mag-item:hover { border-color: var(--accent); background: #fdfaff; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.1); }
.mag-info h4 { font-size: 16px; margin-bottom: 4px; color: #333; }
.mag-info p { font-size: 12px; color: #888; }
.mag-actions { display: flex; gap: 8px; }

/* æ‚å¿—é˜…è¯»è§†å›¾ç‰¹å®šæ ·å¼ */
#articleContent.view-magazine { max-width: 800px; margin: 0 auto; }
.magazine-cover {
  text-align: center; padding: 40px 0; border-bottom: 2px solid #333; margin-bottom: 30px;
  background: radial-gradient(circle at center, #fdfaff 0%, #fff 100%);
}
.magazine-title { font-family: "Georgia", serif; font-size: 42px; font-weight: bold; color: #2c3e50; letter-spacing: -1px; }
.magazine-date { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-top: 10px; }
.magazine-toc { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 40px; border: 1px solid #e9ecef; }
.magazine-toc h3 { font-size: 14px; text-transform: uppercase; color: #888; margin-bottom: 15px; letter-spacing: 1px; }
.toc-link { display: block; padding: 8px 0; border-bottom: 1px dashed #eee; color: #333; text-decoration: none; font-size: 15px; transition: .2s; }
.toc-link:hover { padding-left: 10px; color: var(--accent); }
.mag-article { margin-bottom: 50px; padding-bottom: 30px; border-bottom: 1px solid #eee; }
.mag-article-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #000; }
.mag-article-meta { font-size: 12px; color: #999; margin-bottom: 15px; }
.mag-article-summary { font-size: 16px; line-height: 1.8; color: #444; background: #fff; }
.mag-article-summary strong { color: var(--accent); }

/* æœ—è¯»æŒ‰é’®æ¿€æ´»ï¼ˆæ’­æ”¾ä¸­ï¼‰çŠ¶æ€ */
.btn-icon.reading {
  color: #ff4d4f; /* çº¢è‰²è¡¨ç¤ºåœæ­¢ */
  animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0); }
}
/* ================== [ä¼˜åŒ–] æ‚å¿—ç”Ÿæˆé…ç½®ç•Œé¢æ ·å¼ ================== */
/* å®¹å™¨é—´è·ä¼˜åŒ– */
#magazineConfigModal .modal-box {
  max-width: 550px; /* ç¨å¾®è°ƒå®½ä¸€ç‚¹ */
  padding: 28px;
}

/* è¡¨å•ç»„å¸ƒå±€ */
.mag-config-group {
  margin-bottom: 22px;
  padding-bottom: 15px;
  border-bottom: 1px solid #f0f0f0;
  overflow: hidden;
}
.mag-config-group:last-of-type { border-bottom: none; }

.mag-config-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 14px;
  color: #333;
  margin-bottom: 12px;
}
.mag-config-label i { color: var(--accent); font-size: 16px; }

/* æ•°å­—è¾“å…¥æ¡†ç¾åŒ– */
.mag-input-number {
  display: flex;
  align-items: center;
  gap: 10px;
}
.mag-input-number input {
  width: 80px;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  text-align: center;
  font-weight: bold;
  color: var(--accent);
}

/* è®¢é˜…æºç½‘æ ¼å®¹å™¨ */
.source-select-container {
  max-height: 280px;
  overflow-y: auto;
  background: #fafafa;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* å¼ºåˆ¶ä¸¤åˆ—å¸ƒå±€ï¼Œæ›´æ•´é½ */
  gap: 8px;
  overflow: hidden;
}
/* æ»šåŠ¨æ¡ç¾åŒ– */
.source-select-container::-webkit-scrollbar { width: 5px; }
.source-select-container::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }

/* å•ä¸ªé€‰é¡¹å¡ç‰‡ */
.source-check-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #fff;
  border: 1px solid #eee;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.source-check-item:hover {
  border-color: var(--accent);
  background: #fff8f5;
  transform: translateY(-1px);
}
/* é€‰ä¸­çŠ¶æ€çš„æ¨¡æ‹Ÿ (é€šè¿‡ JS é…åˆæˆ–ç®€å•çš„ CSS é€‰æ‹©å™¨) */
.source-check-item input:checked + span + span { font-weight: 600; color: #000; }

.source-check-item input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--accent);
  cursor: pointer;
}

.source-check-item img {
  width: 18px;
  height: 18px;
  border-radius: 3px;
  object-fit: cover;
  flex-shrink: 0;
}

.source-check-item .source-name {
  font-size: 13px;
  color: #555;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

/* å·¥å…·æ æ ·å¼ */
.mag-config-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding: 0 4px;
}
.mag-sel-info { font-size: 12px; color: #888; }
.mag-sel-info b { color: var(--accent); font-size: 14px; }
.mag-sel-actions { display: flex; gap: 12px; }
.mag-sel-actions a {
  font-size: 12px;
  color: #666;
  text-decoration: none;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  background: #eee;
  transition: .2s;
}
.mag-sel-actions a:hover { background: var(--accent); color: #fff; }

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 480px) {
  .source-select-container { grid-template-columns: 1fr; }
}
</style>
</head>
<body data-view="sidebar">
<!-- 1. è®¢é˜…åˆ—è¡¨ -->
<div id="sidebar" class="layout-col">
  <div class="header-bar">
    <span data-i18n="sidebar.title">æˆ‘çš„è®¢é˜…</span>
    <!-- Flex å¸ƒå±€ï¼Œä½¿æŒ‰é’®æ¨ªå‘æ’åˆ— -->
    <div style="display: flex; align-items: center; gap: 2px;">
      <button class="btn-icon" onclick="openModal('magazineListModal')" data-tooltip="sidebar.magazine">
        <i class="fa-solid fa-book-open" style="color: var(--accent);"></i>
      </button>
      <button class="btn-icon" onclick="openModal('rssSiteModal')" data-tooltip="sidebar.site_explore">
        <i class="fa-solid fa-globe"></i>
      </button>
      <button class="btn-icon" onclick="openModal('exploreModal')" data-tooltip="sidebar.explore"><i class="fa-solid fa-compass"></i></button>
      <button class="btn-icon" onclick="openModal('addFeedModal')" data-tooltip="sidebar.add"><i class="fa-solid fa-plus"></i></button>
      <button class="btn-icon" onclick="openModal('settingsModal')" data-tooltip="sidebar.settings"><i class="fa-solid fa-cog"></i></button>
    </div>
  </div>
  <div class="sidebar-search">
    <i class="fa-solid fa-magnifying-glass"></i>
    <input type="text" id="feedSearchInput" oninput="filterFeeds(this.value)">
  </div>
  <div id="feedList"></div>
  <div id="loadingTips" style="text-align:center; padding:20px; color:#999; font-size:13px; display:none;" data-i18n="sidebar.loading">æ­£åœ¨åŠ è½½è®¢é˜…æº...</div>
</div>
<!-- 2. æ–‡ç« åˆ—è¡¨ -->
<div id="articleList" class="layout-col">
  <div class="header-bar">
    <div style="display:flex; align-items:center; gap:5px; overflow:hidden;">
      <button class="btn-icon mobile-show" onclick="navTo('sidebar')"><i class="fa-solid fa-chevron-left"></i></button>
      <span id="currentFeedTitle" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" data-i18n="list.title_default">æ–‡ç« åˆ—è¡¨</span>
      <span id="cacheIndicator" class="cache-badge"></span>
    </div>
    <button class="btn-icon" onclick="refreshFeed()" data-tooltip="list.refresh"><i class="fa-solid fa-rotate-right"></i></button>
  </div>
  <div id="listContainer" style="padding: 20px; text-align: center; color: #888;" data-i18n="list.select_tip">
    è¯·é€‰æ‹©å·¦ä¾§è®¢é˜…æº
  </div>
</div>
<!-- 3. æ–‡ç« è¯¦æƒ… -->
<div id="contentView" class="layout-col">
  <div class="header-bar">
    <button class="btn-icon mobile-show" onclick="navTo('list')"><i class="fa-solid fa-chevron-left"></i></button>
    
    <!-- [æ–°å¢] è§†å›¾åˆ‡æ¢ç»„ä»¶ -->
    <div class="view-switcher-group" style="margin-left: 10px; position: relative;">
      <button class="btn-icon" onclick="toggleViewMenu()" id="btnViewSwitch" data-tooltip="toolbar.view_mode.label">
        <i class="fa-solid fa-newspaper"></i>
      </button>
      <!-- ä¸‹æ‹‰èœå• -->
      <div id="viewMenu" class="dropdown-menu">
        <div class="dropdown-item active" onclick="changeViewMode('blog')" id="viewOptionBlog">
          <i class="fa-solid fa-align-left"></i> <span data-i18n="toolbar.view_mode.blog">åšå®¢æ¨¡å¼</span>
        </div>
        <div class="dropdown-item" onclick="changeViewMode('gallery')" id="viewOptionGallery">
          <i class="fa-solid fa-images"></i> <span data-i18n="toolbar.view_mode.gallery">ç”»å»Šæ¨¡å¼</span>
        </div>
      </div>
    </div>

    <div style="flex:1"></div>
    
    <!-- AI åŠŸèƒ½åŒº (ä¿æŒä¸å˜) -->
    <button class="btn-icon" id="btnSummarize" onclick="actionSummarize(this)" data-tooltip="toolbar.tip_summarize">
      <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
    <button class="btn-icon" id="btnTranslateFull" onclick="actionTranslateFull(this)" data-tooltip="toolbar.tip_translate">
      <i class="fa-solid fa-language"></i>
    </button>
    <button class="btn-icon" id="btnAskAI" onclick="actionAskAIFull(this)" data-tooltip="toolbar.tip_ask">
      <i class="fa-solid fa-robot"></i>
    </button>
    <button class="btn-icon" id="btnReadFull" onclick="actionReadFull(this)" data-tooltip="toolbar.tip_read">
      <i class="fa-solid fa-headphones"></i>
    </button>
    <button class="btn-icon mobile-hide" onclick="toggleFullScreen()" data-tooltip="content.fullscreen"><i class="fa-solid fa-expand"></i></button>
  </div>

  <div class="article-scroll-area" id="articleScrollArea">
    <div id="placeholder">
      <i class="fa-solid fa-book-open" style="font-size:48px;opacity:0.3"></i>
      <div data-i18n="content.placeholder_text">é€‰æ‹©æ–‡ç« å¼€å§‹é˜…è¯»</div>
    </div>
    
    <!-- å¢åŠ ä¸€ä¸ªåŒ…è£¹å±‚ content-wrapper ç”¨äºæ§åˆ¶å®½çª„ -->
    <div id="articleContent" class="view-blog" style="display:none">
      <div id="articleHeader">
        <h1 id="artTitle"></h1>
        <div class="article-meta">
          <span id="artDate"></span> Â· 
          <a id="artLink" target="_blank"><span data-i18n="content.read_original">é˜…è¯»åŸæ–‡</span> <i class="fa-solid fa-external-link-alt"></i></a>
        </div>
      </div>
      <!-- AI æ€»ç»“å±•ç¤ºåŒº -->
      <div id="aiSummarySection">
        <div class="summary-header"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="content.summary_title">AI æ™ºèƒ½æ€»ç»“</span></div>
        <div id="aiSummaryContent"></div>
      </div>
      <!-- æ–‡ç« æ­£æ–‡ -->
      <div id="articleBody"></div>
    </div>
  </div>
</div>
<!-- æ‚¬æµ®å·¥å…· -->
<div id="selectionToolbar">
  <button onclick="actionTranslateSelection()"><i class="fa-solid fa-language"></i> <span data-i18n="toolbar.translate">ç¿»è¯‘</span></button>
  <div style="width:1px;background:#555;height:14px;margin:0 2px"></div>
  <button onclick="actionAskAI()"><i class="fa-solid fa-robot"></i> <span data-i18n="toolbar.ask_ai">é—® AI</span></button>
  <div style="width:1px;background:#555;height:14px;margin:0 2px"></div>
  <button onclick="actionReadSelection()"><i class="fa-solid fa-volume-high"></i> <span data-i18n="toolbar.read_selection">æœ—è¯»</span></button>
</div>
<div id="translatePopup">
  <div style="display:flex;justify-content:space-between;margin-bottom:8px;color:#888;font-size:12px">
    <span data-i18n="toolbar.translate_result">ç¿»è¯‘ç»“æœ</span><span onclick="this.parentElement.parentElement.style.display='none'" style="cursor:pointer">&times;</span>
  </div>
  <div id="translateResult"></div>
</div>
<!-- æ·»åŠ è®¢é˜… Modal -->
<div id="addFeedModal" class="modal">
  <div class="modal-box">
    <div class="modal-header">
      <span data-i18n="modals.add_title">æ·»åŠ è®¢é˜…</span> 
      <span onclick="closeModal('addFeedModal')" style="cursor:pointer">&times;</span>
    </div>
    
    <!-- åŸæœ‰çš„æ‰‹åŠ¨è¾“å…¥éƒ¨åˆ† -->
    <div class="form-group">
      <label data-i18n="modals.url_label">URL / è·¯ç”±</label>
      <input type="text" id="feedInput" placeholder="/bilibili/ranking/0/3 or rsshub://...">
    </div>
    <div class="form-group">
      <label data-i18n="modals.name_label">è®¢é˜…åç§° (å¯é€‰)</label>
      <input type="text" id="feedNameInput" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
    </div>
    <div class="form-group">
      <label data-i18n="modals.type_label">ç±»å‹</label>
      <select id="feedType">
        <option value="rsshub" data-i18n="modals.type_rsshub">RSSHub è·¯ç”±</option>
        <option value="url" data-i18n="modals.type_url">æ™®é€š RSS URL</option>
      </select>
    </div>

    <!-- [æ–°å¢] OPML å¯¼å…¥åŒºåŸŸ -->
    <div style="margin: 20px 0; border-top: 1px dashed #eee; padding-top: 20px;">
      <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-align: center; text-transform: uppercase;" data-i18n="modals.opml_tip">
        æˆ–è€…æ˜¯... ä»æ–‡ä»¶å¯¼å…¥
      </div>
      <label class="btn btn-ghost" style="display:block; text-align:center; width:100%; border: 1px dashed #ccc; padding: 12px;">
        <i class="fa-solid fa-file-import"></i> <span data-i18n="modals.opml_label">å¯¼å…¥ OPML æ–‡ä»¶</span>
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼Œé€šè¿‡ onchange è§¦å‘ -->
        <input type="file" style="display:none" onchange="handleOpmlImport(this)">
      </label>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:10px">
      <button class="btn btn-ghost" onclick="closeModal('addFeedModal')" data-i18n="modals.btn_cancel">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="addFeed()" data-i18n="modals.btn_confirm">ç¡®è®¤æ·»åŠ </button>
    </div>
  </div>
</div>
<!-- [æ–°å¢] RSS ç«™ç‚¹å‘ç° Modal -->
<div id="rssSiteModal" class="modal">
  <div class="modal-box" style="max-width: 700px; height: 80vh;">
    <div class="modal-header">
      <span data-i18n="modals.site_explore_title">ç²¾é€‰ RSS ç«™ç‚¹</span> 
      <span onclick="closeModal('rssSiteModal')" style="cursor:pointer">&times;</span>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div style="margin-bottom: 15px;">
      <div class="sidebar-search" style="border:1px solid #eee; border-radius:6px; padding:8px; position:static;">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="rssSiteSearch" placeholder="Search..." oninput="filterRssSites()" style="border:none; width:100%; outline:none;">
      </div>
    </div>

    <!-- å¡ç‰‡å®¹å™¨ -->
    <div id="rssSiteList" class="rss-card-grid">
      <div style="text-align:center; padding:50px; color:#999">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading...
      </div>
    </div>
  </div>
</div>
<!-- RSSHub Explorer Modal -->
<div id="exploreModal" class="modal">
  <div class="modal-box" style="max-width: 600px;">
    <div class="modal-header">
      <span data-i18n="explore.title">RSSHub å‘ç°</span> 
      <span onclick="closeModal('exploreModal')" style="cursor:pointer">&times;</span>
    </div>
    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
      <input type="text" id="nsFilter" placeholder="Filter namespace..." oninput="filterNamespaces()" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
    </div>
    <div class="explorer-container">
      <div class="explorer-side" id="nsList">
        <!-- Namespace List -->
        <div style="text-align:center; padding:20px; color:#999"><i class="fa-solid fa-spinner fa-spin"></i></div>
      </div>
      <div class="explorer-main" id="routeList">
        <!-- Routes List -->
        <div style="text-align:center; padding:50px; color:#999" data-i18n="explore.select_ns_tip">è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»</div>
      </div>
    </div>
    <div style="margin-top:10px; font-size:12px; color:#999">
      * æ•°æ®æ¥æº: å½“å‰é…ç½®çš„ RSSHub å®ä¾‹ API
    </div>
  </div>
</div>
<!-- è®¾ç½® Modal -->
<div id="settingsModal" class="modal">
  <!-- æ³¨æ„ï¼šç»™ modal-box å¢åŠ äº† style="overflow: hidden" ä»¥é˜²æ­¢å¤–å±‚æ»šåŠ¨ -->
  <div class="modal-box" style="overflow: hidden; display: flex; flex-direction: column;">
    
    <!-- 1. å¤´éƒ¨ (å›ºå®šä¸åŠ¨) -->
    <div class="modal-header" style="flex-shrink: 0;">
      <span data-i18n="modals.settings_title">å…¨å±€è®¾ç½®</span> 
      <span onclick="closeModal('settingsModal')" style="cursor:pointer">&times;</span>
    </div>

    <!-- 2. ä¸­é—´æ»šåŠ¨åŒºåŸŸ (æ‰€æœ‰è®¾ç½®é¡¹æ”¾è¿™é‡Œ) -->
    <!-- flex: 1 è®©å®ƒå æ®å‰©ä½™ç©ºé—´ï¼Œoverflow-y: auto è®©å®ƒè¶…é«˜æ—¶æ»šåŠ¨ -->
    <div style="flex: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px;">
      
      <div class="form-group">
        <label data-i18n="modals.lang_label">ç•Œé¢è¯­è¨€ / Interface Language</label>
        <select id="langSelect" onchange="changeLanguage(this.value)">
          <option value="zh">ç®€ä½“ä¸­æ–‡</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="form-group">
        <label data-i18n="modals.target_lang_label">AI ç¿»è¯‘ç›®æ ‡è¯­è¨€ / Target Language</label>
        <select id="targetLangSelect">
          <option value="Simplified Chinese">ç®€ä½“ä¸­æ–‡</option>
          <option value="Traditional Chinese">ç¹ä½“ä¸­æ–‡</option>
          <option value="English">English</option>
          <option value="Japanese">Japanese</option>
          <option value="Korean">Korean</option>
          <option value="French">French</option>
          <option value="German">German</option>
          <option value="Spanish">Spanish</option>
          <option value="Russian">Russian</option>
        </select>
      </div>

      <!-- è¿™æ˜¯åˆšæ‰ä¿®æ”¹è¿‡çš„ RSSHub æç¤ºåŒºåŸŸ -->
      <div class="form-group">
        <label data-i18n="modals.hub_label">RSSHub å®ä¾‹åœ°å€</label>
        <input type="text" id="rsshubUrl" placeholder="https://your-rsshub-instance.com" style="margin-bottom: 8px;">
        <div style="font-size: 12px; color: #666; line-height: 1.6; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px dashed #ddd;">
          <i class="fa-solid fa-circle-info" style="color: var(--accent);"></i> 
          <span style="font-weight:bold;" data-i18n="modals.hub_tip_title"></span>ã€‚
          <span data-i18n="modals.hub_tip_desc"></span>
          <div style="margin-top: 6px; display: flex; flex-direction: column; gap: 4px;">
            <a href="https://docs.rsshub.app/zh/guide/instances" target="_blank" style="color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-list-ul"></i> <span data-i18n="modals.hub_tip_public"></span>
            </a>
            <a href="https://docs.rsshub.app/zh/deploy/" target="_blank" style="color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 6px;">
              <i class="fa-solid fa-server"></i> <span data-i18n="modals.hub_tip_deploy"></span>
            </a>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label data-i18n="modals.cache_label">ç¼“å­˜æœ‰æ•ˆæœŸ (åˆ†é’Ÿ)</label>
        <input type="number" id="cacheDuration" min="1" value="30">
        <div style="font-size:12px;color:#999;margin-top:5px" data-i18n="modals.cache_desc">
          é—´éš”å†…å†æ¬¡ç‚¹å‡»ä¸ä¼šæ¶ˆè€—æµé‡ï¼Œç›´æ¥åŠ è½½æœ¬åœ°æ•°æ®ã€‚<br>ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®å¯å¼ºåˆ¶æ›´æ–°ã€‚
        </div>
      </div>

      <div class="form-group">
        <label data-i18n="modals.magazine_hours_label">AI æ‚å¿—æ”¶å½•èŒƒå›´ (å°æ—¶)</label>
        <input type="number" id="magazineHours" min="1" value="24">
      </div>
    </div> <!-- ä¸­é—´æ»šåŠ¨åŒºåŸŸç»“æŸ -->

    <!-- 3. åº•éƒ¨æŒ‰é’® (å›ºå®šä¸åŠ¨) -->
    <div style="flex-shrink: 0; border-top: 1px solid #eee; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
      
      <!-- å·¦ä¾§ï¼šå±é™©æ“ä½œ (å§‹ç»ˆå¯è§) -->
      <button class="btn btn-ghost" style="padding-left: 25px; padding-right: 25px;" onclick="clearCache()" title="Clear Cache">
        <span data-i18n="modals.settings_clear_cache" style="margin-left:4px;">æ¸…ç†ç¼“å­˜</span>
      </button>

      <!-- å³ä¾§ï¼šä¿å­˜æ“ä½œ -->
      <button class="btn btn-primary" style="padding-left: 25px; padding-right: 25px;" onclick="saveSettings()" data-i18n="modals.btn_save">ä¿å­˜é…ç½®</button>
      
    </div>

  </div>
</div>
<!-- æ‚å¿—åˆ—è¡¨ Modal -->
<div id="magazineListModal" class="modal">
  <div class="modal-box" style="height: 70vh;">
    <div class="modal-header">
      <span data-i18n="modals.magazine_title">æˆ‘çš„ AI æ‚å¿—</span> 
      <span onclick="closeModal('magazineListModal')" style="cursor:pointer">&times;</span>
    </div>
    <div id="magazineContainer" style="flex:1; overflow-y:auto; padding: 5px;">
      <!-- åˆ—è¡¨å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
    </div>
    <div style="margin-top:15px; text-align:center;">
      <button class="btn btn-primary" style="width:100%; background: var(--accent);" onclick="openMagConfig()">
        <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="modals.btn_create_magazine">ç”Ÿæˆæ–°åˆŠ</span>
      </button>
    </div>
  </div>
</div>

<!-- [ä¼˜åŒ–ç‰ˆ] æ‚å¿—ç”Ÿæˆé…ç½® Modal -->
<div id="magazineConfigModal" class="modal">
  <div class="modal-box">
    <div class="modal-header">
      <span><i class="fa-solid fa-sliders" style="margin-right:8px; color:var(--accent)"></i><span data-i18n="modals.mag_config_title">å®šåˆ¶ AI æ‚å¿—æ–°åˆŠ</span></span> 
      <span onclick="closeModal('magazineConfigModal')" style="cursor:pointer; color:#999">&times;</span>
    </div>
    
    <!-- è®¾ç½® 1: æ—¶é—´ -->
    <div class="mag-config-group">
      <div class="mag-config-label">
        <i class="fa-regular fa-clock"></i>
        <span data-i18n="modals.mag_config_range">æ”¶å½•èŒƒå›´</span>
      </div>
      <div class="mag-input-number">
        <span style="font-size: 14px; color: #666;" data-i18n="modals.mag_config_hours_prefix">å›é¡¾è¿‡å»</span>
        <input type="number" id="magConfigHours" min="1" value="24">
        <span style="font-size: 14px; color: #666;" data-i18n="modals.mag_config_hours_suffix">å°æ—¶å†…çš„æ–‡ç« </span>
      </div>
    </div>

    <!-- è®¾ç½® 2: æ¥æº -->
    <div class="mag-config-group" style="margin-bottom: 10px;">
      <div class="mag-config-label">
        <i class="fa-solid fa-layer-group"></i>
        <span data-i18n="modals.mag_config_source_label">å†…å®¹æ¥æº</span>
      </div>
      <div class="mag-config-bar">
        <!-- æ³¨æ„è¿™é‡Œï¼šåŠ¨æ€æ–‡æœ¬äº¤ç»™ JS å¤„ç† -->
        <div class="mag-sel-info" id="magSelInfo"></div>
        <div class="mag-sel-actions">
          <a onclick="toggleMagSources(true)" data-i18n="modals.mag_config_select_all">å…¨é€‰</a>
          <a onclick="toggleMagSources(false)" data-i18n="modals.mag_config_unselect_all">å…¨ä¸é€‰</a>
        </div>
      </div>
      <div id="magSourceList" class="source-select-container">
        <!-- JS åŠ¨æ€æ¸²æŸ“ -->
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œ -->
    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:10px;">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('magazineConfigModal')" data-i18n="modals.btn_cancel">å–æ¶ˆ</button>
      <button class="btn btn-primary" style="flex:2; background: linear-gradient(135deg, #ff6b35 0%, #ff8e64 100%);" onclick="startMagazineGeneration()">
        <i class="fa-solid fa-wand-magic-sparkles" style="margin-right:6px"></i><span data-i18n="modals.mag_config_btn_start">å¼€å§‹å°åˆ¶æ–°åˆŠ</span>
      </button>
    </div>
  </div>
</div>

<!-- ç”Ÿæˆè¿›åº¦ Modal (ä¸å¯å…³é—­) -->
<div id="magazineProgressModal" class="modal" style="z-index: 2005;">
  <div class="modal-box">
    <div class="modal-header" style="color:var(--accent)">
      <span data-i18n="modals.magazine_generating_title">æ­£åœ¨å°åˆ¶æ‚å¿—...</span>
    </div>
    <div style="text-align:center; margin-bottom: 20px;">
      <i class="fa-solid fa-robot fa-bounce" style="font-size: 40px; color: var(--accent); margin: 20px 0;"></i>
    </div>
    <div id="magLog" style="height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 6px; font-size: 12px; font-family: monospace; border:1px solid #eee;">
      Initializing...
    </div>
    <div id="magCurrentTask" style="margin-top:10px; font-weight:bold; font-size:13px; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
    
    <!-- å®æ—¶é¢„è§ˆæµå¼æ–‡å­— -->
    <div id="magLiveStream" style="margin-top:10px; padding:10px; background:#f0f8ff; border-left:3px solid var(--accent); font-size:12px; height:60px; overflow:hidden; opacity:0.7;"></div>

    <button id="btnStopMag" class="btn btn-ghost" style="margin-top:15px" onclick="stopMagazineGen()">Stop</button>
  </div>
</div>
<script>
/* ================== DB Helper (IndexedDB) ================== */
const DB_NAME = 'RSS_Reader_DB';
const DB_VERSION = 2; 
const dbHelper = {
  db: null,
  async open() {
    if (this.db) return this.db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('feed_cache')) db.createObjectStore('feed_cache', { keyPath: 'url' });
        if (!db.objectStoreNames.contains('article_meta')) db.createObjectStore('article_meta', { keyPath: 'id' });
        // [æ–°å¢] æ‚å¿—å­˜å‚¨
        if (!db.objectStoreNames.contains('magazines')) db.createObjectStore('magazines', { keyPath: 'id' });
      };
      req.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
      req.onerror = (e) => reject(e);
    });
  },
  async get(storeName, key) {
    const db = await this.open();
    return new Promise((r, j) => {
      const req = db.transaction(storeName, 'readonly').objectStore(storeName).get(key);
      req.onsuccess = () => r(req.result);
      req.onerror = () => j(req.error);
    });
  },
  async put(storeName, val) {
    const db = await this.open();
    return new Promise((r, j) => {
      const req = db.transaction(storeName, 'readwrite').objectStore(storeName).put(val);
      req.onsuccess = () => r(req.result);
      req.onerror = () => j(req.error);
    });
  },
  async clear(storeName) {
    const db = await this.open();
    return new Promise((r, j) => {
      const req = db.transaction(storeName, 'readwrite').objectStore(storeName).clear();
      req.onsuccess = () => r();
      req.onerror = () => j(req.error);
    });
  }
};
/* ================== é…ç½®ä¸çŠ¶æ€ ================== */
const CONFIG = { defaultHub: "", defaultCacheTime: 30, defaultLang: "zh" };
let state = {
  defaultFeeds: [], userFeeds: [], allFeeds: [],featuredRss: [],
  settings: {
    hub: localStorage.getItem('rss_hub') || CONFIG.defaultHub,
    cacheTime: parseInt(localStorage.getItem('rss_cache_time')) || CONFIG.defaultCacheTime,
    lang: localStorage.getItem('rss_lang') || navigator.language.split('-')[0] || CONFIG.defaultLang,
    targetLang: localStorage.getItem('rss_target_lang') || "Simplified Chinese",
    magazineHours: parseInt(localStorage.getItem('rss_mag_hours')) || 24
  },
  activeIdx: -1, articles: [], currentArticle: null, ws: null, i18nData: {},
  // Explorer State
  namespaces: [], currentNs: null
};
if (!['zh', 'en'].includes(state.settings.lang)) state.settings.lang = 'zh';
/* ================== åˆå§‹åŒ– ================== */
document.addEventListener('DOMContentLoaded', async () => {
  initWS();
  await initI18n();
  updateUI();
  document.getElementById('langSelect').value = state.settings.lang;
  await initFeeds();
  document.addEventListener('mouseup', handleSelect);
  document.addEventListener('mousedown', e => {
    if(!document.getElementById('selectionToolbar').contains(e.target)) 
      document.getElementById('selectionToolbar').style.display='none';
  });
  const feedInput = document.getElementById('feedInput');
  const feedType = document.getElementById('feedType');
  if(feedInput) {
    feedInput.addEventListener('input', (e) => {
      const val = e.target.value.trim();
      if(val.startsWith('/') || val.startsWith('rsshub://')) feedType.value = 'rsshub';
      else if(val.startsWith('http')) feedType.value = 'url';
    });
  }
});
/* ================== I18n Logic ================== */
async function initI18n() {
  try {
    const res = await fetch('./i18n.json');
    if (res.ok) state.i18nData = await res.json();
    else state.i18nData = { zh: {}, en: {} };
  } catch(e) {}
}
function t(key) {
  const keys = key.split('.');
  let obj = state.i18nData[state.settings.lang] || {};
  for (let k of keys) { obj = obj[k]; if (!obj) return key; }
  return obj;
}
function getTrTitle(titleField) {
  if (typeof titleField === 'object' && titleField !== null) 
    return titleField[state.settings.lang] || titleField['zh'] || titleField['en'] || "Unnamed";
  return titleField; 
}
function updateUI() {
  document.querySelectorAll('[data-i18n]').forEach(el => el.innerHTML = t(el.getAttribute('data-i18n')));
  document.querySelectorAll('[data-tooltip]').forEach(el => {
    el.setAttribute('data-tooltip-text', t(el.getAttribute('data-tooltip')));
  });
  const searchInput = document.getElementById('feedSearchInput');
  if (searchInput) {
    searchInput.placeholder = t('sidebar.search_placeholder');
  }
  if (state.activeIdx === -1) {
    document.getElementById('currentFeedTitle').innerText = t('list.title_default');
    document.getElementById('listContainer').innerText = t('list.select_tip');
  } else {
    document.getElementById('currentFeedTitle').innerText = getTrTitle(state.allFeeds[state.activeIdx].title);
    const cacheBadge = document.getElementById('cacheIndicator');
    // å¦‚æœæ²¡æœ‰æ­£åœ¨åŠ è½½ï¼Œå°è¯•æ ¼å¼åŒ–æ—¶é—´
    if (cacheBadge.innerText && !cacheBadge.innerHTML.includes('fa-spinner')) {
       cacheBadge.innerText = cacheBadge.innerText.includes(':') 
        ? `${t('list.cache_time_prefix')} ${cacheBadge.innerText.split(' ').pop()}` 
        : t('list.cache_latest');
    }
  }
  if (state.currentArticle) updateTranslateBtnState(state.currentArticle.showingTranslation);
  renderSidebar();
}
function changeLanguage(lang) {
  state.settings.lang = lang;
  localStorage.setItem('rss_lang', lang);
  updateUI();
  if(state.currentArticle) renderArticleBody(state.currentArticle);
}
/* ================== Feed & Cache ================== */
async function initFeeds() {
  const loadingEl = document.getElementById('loadingTips');
  loadingEl.style.display = 'block';
  try {
    const res = await fetch('./default_feeds.json');
    if (res.ok) { state.defaultFeeds = await res.json(); state.defaultFeeds.forEach(f => f.isDefault = true); }
  } catch(e) {}
  try {
    const stored = localStorage.getItem('user_custom_feeds');
    state.userFeeds = stored ? JSON.parse(stored) : [];
  } catch(e) { state.userFeeds = []; }
  updateAllFeeds();
  loadingEl.style.display = 'none';
  if(window.innerWidth > 768 && state.allFeeds.length) loadFeed(0);
}
function updateAllFeeds() {
  state.allFeeds = [...state.defaultFeeds, ...state.userFeeds];
  renderSidebar();
}
async function fetchRSS(feed, force) {
  if (feed.type === 'rsshub' && !state.settings.hub) {
    // è‡ªåŠ¨æ‰“å¼€è®¾ç½®å¼¹çª—
    openModal('settingsModal');
    
    // èšç„¦åˆ°è¾“å…¥æ¡† (ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ä»¥ç¡®ä¿æ¨¡æ€æ¡†åŠ¨ç”»å¼€å§‹)
    setTimeout(() => {
        const input = document.getElementById('rsshubUrl');
        if(input) input.focus();
    }, 100);

    // æŠ›å‡ºå¤šè¯­è¨€é”™è¯¯æç¤º
    throw new Error(t('list.error_no_hub'));
  }
  let url = feed.url;
  // æ„å»ºå®Œæ•´ RSSHub URL
  if(feed.type === 'rsshub') url = url.startsWith('/') ? state.settings.hub.replace(/\/$/, '') + url : state.settings.hub.replace(/\/$/, '') + '/' + url;
  const cacheKey = url;
  const cached = await dbHelper.get('feed_cache', cacheKey);
  const now = Date.now();
  if (!force && cached && (now - cached.time < state.settings.cacheTime * 60000)) {
    return { data: cached.data, fromCache: true, time: cached.time };
  }
  // ä½¿ç”¨é€šç”¨ extension_proxy ä»£ç†
  const res = await fetch(`/extension_proxy?url=${encodeURIComponent(url)}`);
  if(!res.ok) throw new Error(`${t('list.error_backend')} ${res.status}`);
  const text = await res.text();
  const xml = new DOMParser().parseFromString(text, "text/xml");
  if(xml.querySelector("parsererror")) throw new Error(t('list.error_xml'));
  let items = Array.from(xml.querySelectorAll("item"));
  if(!items.length) items = Array.from(xml.querySelectorAll("entry"));
  if(!items.length) throw new Error(t('list.error_empty'));
  const parsedItems = items.map(item => {
    const get = (t) => { const el = item.getElementsByTagName(t)[0]; return el ? el.textContent.trim() : ""; };
    const getLink = () => { const el = item.getElementsByTagName("link")[0]; return el ? (el.getAttribute("href") || el.textContent.trim()) : ""; }
    const desc = get("content:encoded") || get("description") || get("content") || get("summary");
    return {
      title: get("title"), link: getLink(), desc: desc,
      date: (new Date(get("pubDate") || get("published") || "")).toLocaleString(),
      image: (desc.match(/src="([^"]+)"/) || [])[1]
    };
  });
  await dbHelper.put('feed_cache', { url: cacheKey, time: now, data: parsedItems });
  return { data: parsedItems, fromCache: false, time: now };
}
/* ================== UI Render Functions ================== */
function renderSidebar() {
  const list = document.getElementById('feedList');
  list.innerHTML = '';
  state.allFeeds.forEach((f, i) => {
    // ... åŸæœ‰åˆ›å»º div çš„ä»£ç  ...
    const div = document.createElement('div');
    div.className = `feed-item ${i === state.activeIdx ? 'active' : ''}`;
    let iconUrl = f.type === 'rsshub' ? './RSSHub_logo.png' : `https://s2.googleusercontent.com/s2/favicons?domain_url=${new URL(f.url).origin}`;
    div.innerHTML = `<img class="feed-icon" src="${iconUrl}" onerror="this.style.opacity=0"><div class="feed-name">${getTrTitle(f.title)}</div>${f.isDefault ? '<i class="fa-solid fa-lock icon-locked"></i>' : `<button class="btn-delete" onclick="delFeed(${i}, event)">&times;</button>`}`;
    div.onclick = () => loadFeed(i);
    list.appendChild(div);
  });

  // [æ–°å¢] æ¸²æŸ“å®Œåï¼Œç«‹å³æ£€æŸ¥æœç´¢æ¡†æ˜¯å¦æœ‰å†…å®¹ï¼Œå¦‚æœæœ‰ï¼Œé‡æ–°è¿‡æ»¤ä¸€é
  const searchInput = document.getElementById('feedSearchInput');
  if (searchInput && searchInput.value) {
    filterFeeds(searchInput.value);
  }
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“æ–‡ç« åˆ—è¡¨åˆ°ç•Œé¢
async function renderArticleList(items, time, isLoadingBackground = false) {
  // åˆå¹¶å…ƒæ•°æ® (AIæ€»ç»“ã€ç¿»è¯‘ç­‰)
  const merged = await Promise.all(items.map(async (art) => {
       const meta = await dbHelper.get('article_meta', art.link);
       if (meta) { art.aiSummary = meta.summary; art.aiTranslation = meta.translation; art.aiTitleTranslation = meta.titleTranslation; }
       return art;
  }));
  state.articles = merged;

  const container = document.getElementById('listContainer');
  const cacheBadge = document.getElementById('cacheIndicator');
  
  // æ›´æ–°å³ä¸Šè§’ç¼“å­˜çŠ¶æ€
  let timeStr = new Date(time).getHours() + ':' + new Date(time).getMinutes().toString().padStart(2,'0');
  if (isLoadingBackground) {
     cacheBadge.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Updating...`;
  } else {
     cacheBadge.innerText = `${t('list.cache_time_prefix')} ${timeStr}`;
  }

  container.innerHTML = '';
  state.articles.forEach((art, i) => {
    const el = document.createElement('div');
    el.className = `article-card ${art.image?'has-img':''}`;
    el.innerHTML = `<div class="article-title">${art.title.replace(/</g,'&lt;')}</div><div class="article-meta">${art.date}</div>${art.image ? `<img src="${art.image}" class="article-img-preview" loading="lazy">` : ''}`;
    el.onclick = () => showArt(i, el);
    container.appendChild(el);
  });
}

async function loadFeed(idx, force=false) {
  navTo('list');
  state.activeIdx = idx;
  renderSidebar();
  
  const container = document.getElementById('listContainer');
  const cacheBadge = document.getElementById('cacheIndicator');
  const feed = state.allFeeds[idx];
  
  document.getElementById('currentFeedTitle').innerText = getTrTitle(feed.title);
  
  // 1. æ„å»º Cache Key
  let url = feed.url;
  if(feed.type === 'rsshub') url = url.startsWith('/') ? state.settings.hub.replace(/\/$/, '') + url : state.settings.hub.replace(/\/$/, '') + '/' + url;
  const cacheKey = url;

  // 2. å°è¯•ä» DB è·å–ä»»ä½•å¯ç”¨çš„ç¼“å­˜ (Stale-While-Revalidate)
  const cached = await dbHelper.get('feed_cache', cacheKey);
  let hasRenderedCache = false;

  if (cached && cached.data && cached.data.length > 0) {
    // ä¹è§‚æ¸²æŸ“ï¼šå…ˆæ˜¾ç¤ºç¼“å­˜å†…å®¹
    await renderArticleList(cached.data, cached.time, true); 
    hasRenderedCache = true;
  } else {
    // æ— ç¼“å­˜ï¼Œæ˜¾ç¤º Loading
    cacheBadge.innerText = "";
    container.innerHTML = `<div class="spinner" style="margin-top:50px"></div><div style="margin-top:10px;color:#999;font-size:12px">${t('list.loading')}</div>`;
  }

  try {
    // 3. å‘èµ·è¯·æ±‚ (å¦‚æœ force=true æˆ–è€…ç¼“å­˜è¿‡æœŸï¼ŒfetchRSS ä¼šå‘èµ·ç½‘ç»œè¯·æ±‚)
    // æ³¨æ„ï¼šfetchRSS å†…éƒ¨æœ‰æ—¶é—´åˆ¤æ–­ï¼Œä½†å¦‚æœæ˜¯ force=true åˆ™ä¼šå¿½ç•¥æ—¶é—´
    // ä¸ºäº†å®ç°"ç‚¹å‡»åˆ—è¡¨ä¸åˆ·æ–°ï¼Œç‚¹å‡»æŒ‰é’®æ‰åˆ·æ–°"çš„é€»è¾‘ï¼š
    // å¦‚æœæ˜¯ç‚¹å‡»ä¾§è¾¹æ (force=false)ï¼Œä¸”ä¸Šé¢å·²ç»æ¸²æŸ“äº†ç¼“å­˜ï¼ŒfetchRSS å¯èƒ½ä¼šç›´æ¥è¿”å›ç¼“å­˜ (fromCache: true)
    // å¦‚æœæ˜¯ç‚¹å‡»åˆ·æ–°æŒ‰é’®(force=true)ï¼Œåˆ™ fetchRSS ä¼šå¼ºåˆ¶è”ç½‘
    
    const result = await fetchRSS(feed, force);
    
    // å¦‚æœä¹‹å‰å·²ç»æ¸²æŸ“äº†ç¼“å­˜ï¼Œä¸” fetchRSS è¿”å›çš„è¿˜æ˜¯åŒä¸€ä»½ç¼“å­˜ï¼Œåˆ™åªæ›´æ–° Badge çŠ¶æ€å³å¯ï¼Œæ— éœ€é‡ç»˜
    if (hasRenderedCache && result.fromCache && result.time === cached.time && !force) {
        // ä»…ä»…æ˜¯å»æ‰äº† Loading çŠ¶æ€
        let timeStr = new Date(result.time).getHours() + ':' + new Date(result.time).getMinutes().toString().padStart(2,'0');
        cacheBadge.innerText = `${t('list.cache_time_prefix')} ${timeStr}`;
        return;
    }
    
    // å¦‚æœæœ‰æ–°æ•°æ®ï¼ˆç½‘ç»œè¯·æ±‚è¿”å›ï¼Œæˆ–è€… force åˆ·æ–°ï¼‰ï¼Œåˆ™é‡æ–°æ¸²æŸ“
    await renderArticleList(result.data, result.time, false);
    
  } catch(e) {
    if (hasRenderedCache) {
       // å¦‚æœå·²æœ‰å†…å®¹ï¼Œåªæ˜¯åå°åˆ·æ–°å¤±è´¥ï¼Œåˆ™å¼¹çª—æç¤ºï¼Œä¸ç ´åå½“å‰ç•Œé¢
       // æ¢å¤ Badge çŠ¶æ€
       let timeStr = new Date(cached.time).getHours() + ':' + new Date(cached.time).getMinutes().toString().padStart(2,'0');
       cacheBadge.innerText = `${t('list.cache_time_prefix')} ${timeStr}`;
       alert(`${t('list.error_backend')}: ${e.message}`);
    } else {
       // æ— å†…å®¹ä¸”å¤±è´¥
       container.innerHTML = `<div style="padding:40px;color:#f55"><div>${e.message}</div><button class="btn btn-primary" style="margin-top:10px" onclick="loadFeed(${idx},true)">${t('list.retry')}</button></div>`;
    }
  }
}

function showArt(i, el) {
  navTo('content');
  document.querySelectorAll('.article-card').forEach(e=>e.classList.remove('active'));
  if(el) el.classList.add('active');
  state.currentArticle = state.articles[i];
  renderArticleBody(state.currentArticle);
}
function updateTranslateBtnState(isTrans) {
  const btn = document.getElementById('btnTranslateFull');
  const span = btn.querySelector('span'); // å°è¯•å¯»æ‰¾ span
  
  // é€»è¾‘ä¿®æ”¹ï¼šåªæœ‰å½“ span å­˜åœ¨æ—¶ï¼Œæ‰å»ä¿®æ”¹æ–‡å­—
  if (span) {
    if (isTrans) {
      span.innerText = t('content.toggle_original');
    } else {
      span.innerText = t('toolbar.translate_full');
    }
  }

  // æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€ï¼ˆå˜è‰²ï¼‰ä¾ç„¶éœ€è¦æ‰§è¡Œ
  if (isTrans) { 
    btn.classList.add('active'); 
  } else { 
    btn.classList.remove('active'); 
  }
}
/* ================== RSSHub Explorer Logic ================== */
async function loadNamespaces() {
  const listEl = document.getElementById('nsList');
  listEl.innerHTML = `<div style="text-align:center; padding:20px; color:#999"><i class="fa-solid fa-spinner fa-spin"></i></div>`;
  try {
    const hub = state.settings.hub.replace(/\/$/, '');
    const url = `${hub}/api/namespace`;
    // Use generic proxy for JSON API
    const res = await fetch(`/extension_proxy?url=${encodeURIComponent(url)}`, { headers: { 'Accept': 'application/json' }});
    if(!res.ok) throw new Error("API Error");
    const data = await res.json();
    state.namespaces = Object.keys(data).sort(); // data is object like { bilibili: ..., weibo: ... } or list
    if(Array.isArray(data)) state.namespaces = data.sort();
    renderNamespaces();
  } catch(e) {
    listEl.innerHTML = `<div style="padding:10px; color:red; font-size:12px;">Load Failed: ${e.message}<br>Check RSSHub URL in settings.</div>`;
  }
}
function renderNamespaces(filterText = "") {
  const listEl = document.getElementById('nsList');
  listEl.innerHTML = "";
  const filtered = state.namespaces.filter(ns => ns.toLowerCase().includes(filterText.toLowerCase()));
  filtered.forEach(ns => {
    const div = document.createElement('div');
    div.className = `ns-item ${state.currentNs === ns ? 'active' : ''}`;
    div.innerText = ns;
    div.onclick = () => loadRoutes(ns);
    listEl.appendChild(div);
  });
}
function filterNamespaces() {
  const val = document.getElementById('nsFilter').value;
  renderNamespaces(val);
}

// æ”¯æŒ Markdown-it + Container æ¸²æŸ“å’Œè·¯å¾„æ‹¼æ¥
async function loadRoutes(ns) {
  state.currentNs = ns;
  renderNamespaces(document.getElementById('nsFilter').value);
  const routeListEl = document.getElementById('routeList');
  routeListEl.innerHTML = `<div style="text-align:center; padding:50px; color:#999"><i class="fa-solid fa-spinner fa-spin"></i> Loading routes...</div>`;
  try {
    const hub = state.settings.hub.replace(/\/$/, '');
    const url = `${hub}/api/namespace/${ns}`;
    const res = await fetch(`/extension_proxy?url=${encodeURIComponent(url)}`, { headers: { 'Accept': 'application/json' }});
    const data = await res.json();
    routeListEl.innerHTML = "";
    const routes = data.routes || {};
    if(Object.keys(routes).length === 0) {
      routeListEl.innerHTML = `<div style="padding:20px; color:#999">No routes found via API.</div>`;
      return;
    }
    Object.entries(routes).forEach(([pathKey, info]) => {
      // 1. è®¡ç®—å®Œæ•´è·¯å¾„
      let fullPath = pathKey;
      if (!pathKey.toLowerCase().startsWith(`/${ns.toLowerCase()}`)) {
         fullPath = `/${ns}${pathKey.startsWith('/') ? '' : '/'}${pathKey}`;
      }
      const div = document.createElement('div');
      div.className = "route-item";
      // 2. æ„å»ºå‚æ•°è¯´æ˜
      let paramsHtml = '<div style="font-style:italic; color:#999; margin:5px 0">æ— å‚æ•°</div>';
      if (info.parameters && Object.keys(info.parameters).length > 0) {
        let rows = '';
        for (const [pKey, pVal] of Object.entries(info.parameters)) {
          let desc = typeof pVal === 'object' ? (pVal.description || JSON.stringify(pVal)) : pVal;
          if (typeof pVal === 'object' && pVal.options) {
             desc += '<br><strong>Options:</strong> ' + pVal.options.map(o => o.value).join(', ');
          }
          rows += `<tr>
            <td><span class="param-badge">:${pKey}</span></td>
            <td>${desc}</td>
          </tr>`;
        }
        paramsHtml = `<table class="param-table">
          <thead><tr><th>å‚æ•° / Param</th><th>è¯´æ˜ / Description</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      }
      // 3. æ„å»ºæè¿°ä¸ç¤ºä¾‹ (ä½¿ç”¨ markdown-it + container æ¸²æŸ“)
      let descHtml = '';
      if (info.description) {
         if (typeof window.markdownit !== 'undefined') {
            const md = window.markdownit({
                html: true,
                linkify: true,
                breaks: true
            });
            // æ³¨å†Œå®¹å™¨æ’ä»¶ (Tip, Warning, Danger)
            if (typeof window.markdownitContainer !== 'undefined') {
                const registerContainer = (name, title) => {
                    md.use(window.markdownitContainer, name, {
                        render: function (tokens, idx) {
                            if (tokens[idx].nesting === 1) {
                                return `<div class="admonition ${name}"><span class="admonition-title">${title}</span>`;
                            } else {
                                return '</div>\n';
                            }
                        }
                    });
                };
                registerContainer('tip', 'æç¤º / Tip');
                registerContainer('warning', 'æ³¨æ„ / Warning');
                registerContainer('danger', 'è­¦å‘Š / Danger');
            }
            const rawHtml = md.render(info.description);
            // hack: è®©é“¾æ¥ target="_blank"
            descHtml = `<div class="md-content">${rawHtml.replace(/<a /g, '<a target="_blank" ')}</div>`;
         } else {
            descHtml = `<div style="margin-bottom:8px; line-height:1.4">${cleanMarkdown(info.description)}</div>`;
         }
      }
      const exampleHtml = info.example ? `<div style="background:#eee; padding:4px; border-radius:4px; margin-bottom:8px; font-family:monospace; word-break:break-all; font-size:11px;">Example: ${info.example}</div>` : '';
      div.innerHTML = `
        <div class="route-header">
          <div>
            <div class="route-title">${info.name || info.title || pathKey}</div>
            <div class="route-path-preview">${fullPath}</div>
          </div>
          <i class="fa-solid fa-chevron-down" style="font-size:12px; color:#ccc; transition:.2s"></i>
        </div>
        <div class="route-details" onclick="event.stopPropagation()">
          ${descHtml}
          ${exampleHtml}
          ${paramsHtml}
          <div style="overflow:hidden">
            <button class="use-btn" onclick="selectRoute('${fullPath.replace(/'/g, "\\'")}', '${(info.name || info.title || ns).replace(/'/g, "\\'")}')">
              <i class="fa-solid fa-check"></i> ä½¿ç”¨æ­¤è·¯ç”± / Use
            </button>
          </div>
        </div>
      `;
      // ç‚¹å‡»å±•å¼€/æ”¶èµ·é€»è¾‘
      div.onclick = function() {
        const isExpanded = this.classList.contains('expanded');
        document.querySelectorAll('.route-item.expanded').forEach(el => {
            el.classList.remove('expanded');
            el.querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';
        });
        if (!isExpanded) {
          this.classList.add('expanded');
          this.querySelector('.fa-chevron-down').style.transform = 'rotate(180deg)';
          setTimeout(() => this.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }
      };
      routeListEl.appendChild(div);
    });
  } catch(e) {
    routeListEl.innerHTML = `<div style="padding:20px; color:red">Error loading routes: ${e.message}</div>`;
  }
}
// è¾…åŠ©å‡½æ•°ï¼šå°†é€‰ä¸­çš„è·¯ç”±å¡«å›æ·»åŠ æ¡†
window.selectRoute = function(path, title) {
  closeModal('exploreModal');
  openModal('addFeedModal');
  document.getElementById('feedInput').value = path;
  document.getElementById('feedType').value = 'rsshub';
  document.getElementById('feedNameInput').value = title;
  // è§†è§‰åé¦ˆ
  const input = document.getElementById('feedInput');
  input.style.transition = 'background 0.2s';
  input.style.background = '#e6fffa';
  setTimeout(() => input.style.background = '#fafafa', 500);
}
/* ================== Stream Core ================== */
async function streamAIRequest(sys, user, onChunk, onFinish) {
  try {
    const res = await fetch('/simple_chat', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: [{ role: "system", content: sys }, { role: "user", content: user }], stream: true })
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop(); 
      for (const line of lines) {
        if (!line.trim()) continue;
        try {
          const content = JSON.parse(line).choices?.[0]?.delta?.content || "";
          if (content) onChunk(content);
        } catch (e) {}
      }
    }
    if(onFinish) onFinish();
  } catch (e) { console.error(e); alert(t('toolbar.translate_fail') + ": " + e.message); }
}
function cleanMarkdown(text) { 
  if(!text) return "";
  return text
    .replace(/^```html\s*/i, '')
    .replace(/```$/, '')
    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
    .replace(/\n/g, '<br>')
    .trim(); 
}
/* ================== Action Logic ================== */
function setToolbarBusy(isBusy) {
  const btns = ['btnSummarize', 'btnTranslateFull', 'btnAskAI'];
  btns.forEach(id => {
    const btn = document.getElementById(id);
    if(btn) btn.disabled = isBusy;
  });
}
// ================== ä¿®æ”¹ï¼šä½¿ç”¨ markdown-it æ¸²æŸ“æ€»ç»“ ==================
async function actionSummarize(btn) {
  const art = state.currentArticle;
  if (!art) return;
  setToolbarBusy(true);
  const summarySec = document.getElementById('aiSummarySection');
  summarySec.style.display = 'block';
  document.getElementById('aiSummaryContent').innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${t('content.generating')}`;
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = art.desc;
  const rawText = tempDiv.innerText.replace(/\s+/g, '\n').slice(0, 10000);
  let fullText = "";
  const targetLang = state.settings.targetLang;
  // åˆå§‹åŒ– markdown-it å®ä¾‹
  const md = window.markdownit({
      html: true,
      linkify: true,
      breaks: true
  });
  // æ³¨å†Œå®¹å™¨æ’ä»¶ (Tip, Warning, Danger)
  if (typeof window.markdownitContainer !== 'undefined') {
      const registerContainer = (name, title) => {
          md.use(window.markdownitContainer, name, {
              render: function (tokens, idx) {
                  if (tokens[idx].nesting === 1) {
                      return `<div class="admonition ${name}"><span class="admonition-title">${title}</span>`;
                  } else {
                      return '</div>\n';
                  }
              }
          });
      };
      registerContainer('tip', 'æç¤º / Tip');
      registerContainer('warning', 'æ³¨æ„ / Warning');
      registerContainer('danger', 'è­¦å‘Š / Danger');
  }
  await streamAIRequest(
    `Summarize the following article in ${targetLang}. Output in Markdown format. Use lists for points. Use headings for structure.`, 
    rawText, 
    (chunk) => { 
      fullText += chunk; 
      // ä½¿ç”¨ md.render æ›¿ä»£ cleanMarkdown
      document.getElementById('aiSummaryContent').innerHTML = md.render(fullText); 
    }, 
    async () => { 
      art.aiSummary = md.render(fullText); 
      await saveArticleMeta(art); 
      setToolbarBusy(false);
    }
  );
}
/* ================== æ–°å¢ï¼šæµå¼ç»“æ„åŒ–ç¿»è¯‘æ ¸å¿ƒé€»è¾‘ ================== */
/**
 * å¤„ç†æ•´ç¯‡æ–‡ç« çš„ç¿»è¯‘
 * ç­–ç•¥ï¼šè¯†åˆ«æ®µè½çº§åˆ«çš„å…ƒç´ ï¼Œæå–å…¶ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¹¶è¡Œç¿»è¯‘åæµå¼å›å¡«
 */
async function translateArticleContent(contentEl, targetLang) {
  // 1. è·å–æ‰€æœ‰å¯ç¿»è¯‘çš„å—çº§å…ƒç´ 
  // é€‰æ‹©å™¨ï¼šp, h1-h6, li, blockquote, td, th
  const selectors = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'blockquote', 'td', 'th', 'div'];
  const blocks = Array.from(contentEl.querySelectorAll(selectors.join(',')));
  // 2. è¿‡æ»¤å¹¶å‡†å¤‡ç¿»è¯‘ä»»åŠ¡
  const translationTasks = [];
  const skipTags = ['SCRIPT', 'STYLE', 'CODE', 'PRE', 'NOSCRIPT', 'IFRAME', 'SVG'];
  blocks.forEach((block) => {
    // æ£€æŸ¥æ˜¯å¦åœ¨ä¸å¯ç¿»è¯‘çš„å®¹å™¨å†…
    if (block.closest('code, pre, noscript, script')) return;
    if (skipTags.includes(block.tagName)) return;
    // è·å–å—å†…æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
    const textNodes = [];
    const walker = document.createTreeWalker(block, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
      const text = node.textContent.trim();
      if (text.length > 0) {
        textNodes.push(node);
      }
    }
    if (textNodes.length > 0) {
      // å°†æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹å†…å®¹æ‹¼æ¥
      const originalText = textNodes.map(n => n.textContent).join(' ').trim();
      if (originalText.length < 2) return; // å¤ªçŸ­ä¸ç¿»è¯‘
      translationTasks.push({
        blockElement: block,
        textNodes: textNodes,
        originalText: originalText
      });
    }
  });
  console.log(`Found ${translationTasks.length} translatable blocks.`);
  // 3. å¹¶è¡Œå‘èµ·ç¿»è¯‘ä»»åŠ¡ (ä½¿ç”¨ Promise.all)
  await Promise.all(translationTasks.map(task => translateBlock(task, targetLang)));
}
/**
 * ç¿»è¯‘å•ä¸ªå—å…ƒç´  (ä¼˜åŒ–æŠ–åŠ¨ç‰ˆæœ¬)
 */
async function translateBlock(task, targetLang) {
  const { blockElement, textNodes, originalText } = task;
  // æ ‡è®°çŠ¶æ€
  blockElement.setAttribute('data-translating', 'true');
  let currentTranslation = "";
  const firstTextNode = textNodes[0];
  let rafId = null; // ç”¨äº requestAnimationFrame çš„ ID
  let isFirstChunk = true; // æ ‡è®°æ˜¯å¦æ˜¯ç¬¬ä¸€æ®µæµ
  // ä¸ºäº†ä¿æŒç»“æ„ï¼ˆå¦‚å›¾ç‰‡ï¼‰ï¼Œæˆ‘ä»¬å°†ç¿»è¯‘ç»“æœæµå¼å¡«å……åˆ°ç¬¬ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹
  // ç­–ç•¥ï¼šå»¶è¿Ÿæ¸…ç†åç»­æ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´åˆ°ç¬¬ä¸€æ®µç¿»è¯‘åˆ°æ¥ï¼Œé˜²æ­¢é«˜åº¦ç¬é—´åç¼©
  await streamAIRequest(
    `Translate the following text to ${targetLang}. Return ONLY the translated text. Do not include any markdown or HTML tags. Keep it natural.`,
    originalText,
    (chunk) => {
      currentTranslation += chunk;
      // === å…³é”®ä¿®å¤ï¼šä½¿ç”¨ requestAnimationFrame èŠ‚æµ DOM æ›´æ–° ===
      if (!rafId) {
        rafId = requestAnimationFrame(() => {
          // ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶ï¼Œæ¸…ç†æ‰åç»­çš„åŸå§‹æ–‡æœ¬èŠ‚ç‚¹ï¼Œé˜²æ­¢å†…å®¹é‡å¤
          if (isFirstChunk) {
            for (let i = 1; i < textNodes.length; i++) {
              textNodes[i].textContent = "";
            }
            isFirstChunk = false;
          }
          // æ›´æ–°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ–‡æœ¬
          firstTextNode.textContent = currentTranslation;
          rafId = null; // é‡ç½® IDï¼Œå…è®¸ä¸‹ä¸€æ¬¡è¯·æ±‚
        });
      }
    },
    () => {
      // å®Œæˆå
      if (rafId) cancelAnimationFrame(rafId); // å–æ¶ˆå¯èƒ½å­˜åœ¨çš„æœ€åä¸€å¸§è¯·æ±‚
      // ç¡®ä¿æœ€åä¸€æ¬¡æ›´æ–°è¢«åº”ç”¨
      firstTextNode.textContent = currentTranslation;
      for (let i = 1; i < textNodes.length; i++) textNodes[i].textContent = "";
      blockElement.removeAttribute('data-translating');
      blockElement.setAttribute('data-translated', 'true');
      // æ·»åŠ æ·¡å…¥åŠ¨ç”»ç±»ï¼Œç¨åç§»é™¤
      blockElement.classList.add('trans-fade-in');
      setTimeout(() => blockElement.classList.remove('trans-fade-in'), 500);
    }
  );
}
// ================== ä¿®æ”¹ï¼šactionTranslateFull å‡½æ•° ==================
async function actionTranslateFull(btn) {
  const art = state.currentArticle;
  if (!art) return;
  // å¦‚æœå·²ç»åœ¨æ˜¾ç¤ºç¿»è¯‘ï¼Œåˆ‡å›åŸæ–‡
  if (art.showingTranslation) {
    art.showingTranslation = false;
    renderArticleBody(art);
    return;
  }
  // å¦‚æœå·²ç»æœ‰ç¼“å­˜çš„ç¿»è¯‘ï¼Œç›´æ¥æ˜¾ç¤º
  if (art.aiTranslation && art.aiTitleTranslation) {
    art.showingTranslation = true;
    renderArticleBody(art);
    return;
  }
  setToolbarBusy(true);
  updateTranslateBtnState(true);
  const bodyEl = document.getElementById('articleBody');
  const titleEl = document.getElementById('artTitle');
  // ç¡®ä¿å†…å®¹å·²æ¸²æŸ“ï¼ˆæ¸²æŸ“åŸæ–‡ä½œä¸ºåŸºç¡€ï¼‰
  bodyEl.innerHTML = art.desc;
  const targetLang = state.settings.targetLang;
  // --- 1. ç¿»è¯‘æ ‡é¢˜ ---
  let translatedTitle = "";
  const originalTitle = art.title;
  // æ ‡é¢˜ç¿»è¯‘æŒ‡ç¤ºå™¨
  titleEl.innerHTML = `<span style="display:flex; align-items:center; gap:6px">
    <span style="color:#666; opacity:0.7">${originalTitle}</span>
    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:0.8em; color:var(--accent)"></i>
  </span>`;
  await streamAIRequest(
    `Translate title to ${targetLang}. Return ONLY the translated text.`,
    originalTitle,
    (chunk) => {
      translatedTitle += chunk;
      // æ ‡é¢˜æµå¼æ˜¾ç¤ºï¼šæ˜¾ç¤ºè¯‘æ–‡ + åŸæ–‡(å°å­—)
      titleEl.innerHTML = `<span>${translatedTitle}</span>`;
    },
    () => {
      art.aiTitleTranslation = translatedTitle.trim();
      // ç¿»è¯‘å®Œæˆåï¼Œä¹Ÿå¯ä»¥é€‰æ‹©éšè—åŸæ–‡ï¼Œæˆ–è€…ä¿ç•™åœ¨ title å±æ€§ä¸­
      titleEl.title = originalTitle; 
    }
  );
  // --- 2. ç¿»è¯‘æ­£æ–‡ (ä½¿ç”¨æ–°çš„ç»“æ„åŒ–æµå¼ç¿»è¯‘) ---
  try {
    // è¿™é‡Œä¼šå¹¶è¡Œå¤„ç†å„ä¸ªæ®µè½
    await translateArticleContent(bodyEl, targetLang);
    // ä¿å­˜ç¿»è¯‘åçš„å®Œæ•´ HTML
    art.aiTranslation = bodyEl.innerHTML;
    art.showingTranslation = true;
    await saveArticleMeta(art);
    console.log('Article translation completed and saved.');
  } catch (error) {
    console.error('Translation failed:', error);
    alert('Translation process encountered an error. Please try again.');
    // æ¢å¤åŸçŠ¶
    bodyEl.innerHTML = art.desc;
  }
  setToolbarBusy(false);
}
async function saveArticleMeta(art) {
  if (!art.link) return;
  await dbHelper.put('article_meta', {
    id: art.link,
    summary: art.aiSummary || null,
    translation: art.aiTranslation || null,
    titleTranslation: art.aiTitleTranslation || null,
    timestamp: Date.now()
  });
}
async function actionTranslateSelection() {
  const pop = document.getElementById('translatePopup');
  const bar = document.getElementById('selectionToolbar');
  pop.style.display = 'block'; pop.style.top = bar.style.top; pop.style.left = bar.style.left; bar.style.display = 'none';
  const resEl = document.getElementById('translateResult');
  resEl.innerHTML = '<div class="spinner"></div>';
  let full = "", first = true;
  await streamAIRequest(`Translate to ${state.settings.targetLang}.`, window.getSelection().toString().trim(), (c) => {
    if(first){ resEl.innerHTML=""; first=false; } full+=c; resEl.innerText=full;
  });
}
function actionAskAIFull(btn) {
  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return alert("WS Disconnected");
  state.ws.send(JSON.stringify({ type: 'set_user_input', data: { text: `å…³äºã€Š${document.getElementById('artTitle').innerText}ã€‹:\n${document.getElementById('articleBody').innerText}` } }));
  const icon = btn.querySelector('i'); const cls = icon.className; icon.className = 'fa-solid fa-check'; setTimeout(() => icon.className = cls, 1500);
}
function actionAskAI() {
  state.ws.send(JSON.stringify({ type: 'set_user_input', data: { text: `å…³äºã€Š${document.getElementById('artTitle').innerText}ã€‹:\n${window.getSelection().toString()}` } }));
  document.getElementById('selectionToolbar').style.display='none';
}
/* ================== Utils ================== */
async function clearCache() {
  if(confirm(t('alerts.cache_clear_confirm'))) {
    await dbHelper.clear('feed_cache'); await dbHelper.clear('article_meta');
    localStorage.removeItem('rss_cache_data'); alert(t('sidebar.cleared')); location.reload();
  }
}
function addFeed() { 
  let url = document.getElementById('feedInput').value.trim();
  let type = document.getElementById('feedType').value;
  let name = document.getElementById('feedNameInput').value.trim();
  if(!url) return;
  if (url.startsWith('rsshub://')) { type = 'rsshub'; url = url.replace('rsshub://', ''); if(!url.startsWith('/')) url='/'+url; }
  else if (url.startsWith('/')) type = 'rsshub';
  if(!name) name = type === 'rsshub' ? url.split('/').filter(p=>p).slice(0,2).join('/') : new URL(url.startsWith('http')?url:'http://'+url).hostname;
  state.userFeeds.push({ title: name, url, type });
  saveUserFeeds(); updateAllFeeds(); closeModal('addFeedModal'); loadFeed(state.allFeeds.length-1);
}
function delFeed(i, e) {
  e.stopPropagation();
  if (state.allFeeds[i].isDefault) return alert(t('alerts.default_locked'));
  if(confirm(t('alerts.delete_confirm'))) { 
    state.userFeeds.splice(i - state.defaultFeeds.length, 1);
    saveUserFeeds(); updateAllFeeds(); 
    if(state.activeIdx>=i) state.activeIdx=-1;
    document.getElementById('listContainer').innerHTML = `<div style="padding:40px;color:#999">${t('list.select_tip')}</div>`;
  }
}
function setHub(u) { document.getElementById('rsshubUrl').value = u; }
function saveUserFeeds() { localStorage.setItem('user_custom_feeds', JSON.stringify(state.userFeeds)); }
function saveSettings() {
    state.settings.hub = document.getElementById('rsshubUrl').value.replace(/\/$/, '');
    state.settings.cacheTime = parseInt(document.getElementById('cacheDuration').value) || 30;
    state.settings.targetLang = document.getElementById('targetLangSelect').value;
    state.settings.magazineHours = parseInt(document.getElementById('magazineHours').value) || 24;
    localStorage.setItem('rss_mag_hours', state.settings.magazineHours);
    localStorage.setItem('rss_hub', state.settings.hub);
    localStorage.setItem('rss_cache_time', state.settings.cacheTime);
    localStorage.setItem('rss_target_lang', state.settings.targetLang);
    closeModal('settingsModal');
    if(state.activeIdx >=0) loadFeed(state.activeIdx);
}
function refreshFeed() { if(state.activeIdx>=0) loadFeed(state.activeIdx, true); }
function toggleFullScreen() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
function initWS() {
  const p = location.protocol==='https:'?'wss:':'ws:';
  state.ws = new WebSocket(`${p}//${location.host}/ws`);
  state.ws.onclose = () => setTimeout(initWS, 3000);
}
function handleSelect() {
  setTimeout(() => {
    const t = window.getSelection().toString().trim();
    const bar = document.getElementById('selectionToolbar');
    if(t) {
      const r = window.getSelection().getRangeAt(0).getBoundingClientRect();
      bar.style.display = 'flex';
      bar.style.top = (r.top - 45 < 0 ? r.bottom + 10 : r.top - 45) + 'px';
      bar.style.left = Math.max(10, Math.min(window.innerWidth - 110, r.left + r.width/2 - 50)) + 'px';
    } else bar.style.display = 'none';
  }, 100);
}
function navTo(view) { document.body.setAttribute('data-view', view); }
function openModal(id) { 
  document.getElementById(id).classList.add('active'); 
  if(id === 'settingsModal') { 
    document.getElementById('rsshubUrl').value = state.settings.hub; 
    document.getElementById('cacheDuration').value = state.settings.cacheTime; 
    document.getElementById('targetLangSelect').value = state.settings.targetLang;
    document.getElementById('magazineHours').value = state.settings.magazineHours; 
  } 
  if(id === 'addFeedModal') { 
    document.getElementById('feedInput').value = ''; 
    document.getElementById('feedNameInput').value = ''; 
  }
  if(id === 'exploreModal') {
    // é»˜è®¤æ‰“å¼€æ—¶ï¼Œå¦‚æœè¿˜æ²¡åŠ è½½ namespaceï¼ŒåŠ è½½å®ƒä»¬
    if(state.namespaces.length === 0) loadNamespaces();
    
    // [æ–°å¢] é‡ç½®å³ä¾§æ˜¾ç¤ºä¸ºæç¤ºä¿¡æ¯
    document.getElementById('routeList').innerHTML = `<div style="text-align:center; padding:50px; color:#999" data-i18n="explore.select_ns_tip">${t('explore.select_ns_tip')}</div>`;
    
    // [æ–°å¢] æ¸…é™¤å½“å‰çš„é€‰ä¸­çŠ¶æ€
    state.currentNs = null;
    // é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ä»¥ç§»é™¤é«˜äº®
    renderNamespaces(document.getElementById('nsFilter').value);
  }
  if (id === 'rssSiteModal') {
    document.getElementById('rssSiteSearch').placeholder = t('modals.site_search_placeholder');
    if (state.featuredRss.length === 0) {
      loadFeaturedRss();
    } else {
      // å¦‚æœå·²æœ‰æ•°æ®ï¼Œä¸ºäº†é¿å…ä¹‹å‰çš„æœç´¢æ®‹ç•™ï¼Œå¯ä»¥é‡ç½®å¹¶æ¸²æŸ“
      document.getElementById('rssSiteSearch').value = '';
      renderRssSites(state.featuredRss);
    }
  }
  if (id === 'magazineListModal') {
    loadMagazineList();
  }
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.addEventListener('click', e => {
  const l = e.target.closest('a');
  if (l && l.href && l.href.startsWith('http')) l.target = '_blank';
}, true);
/* ================== View Mode Logic ================== */
let currentViewMode = 'blog'; // é»˜è®¤åšå®¢æ¨¡å¼

// åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º
function toggleViewMenu() {
  const menu = document.getElementById('viewMenu');
  // ç®€å•çš„æ˜¾éšåˆ‡æ¢
  if(menu.style.display === 'block') {
    menu.style.display = 'none';
  } else {
    menu.style.display = 'block';
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    const closeListener = (e) => {
      if(!e.target.closest('.view-switcher-group')) {
        menu.style.display = 'none';
        document.removeEventListener('click', closeListener);
      }
    };
    // å»¶è¿Ÿä¸€ç‚¹ç»‘å®šï¼Œé˜²æ­¢ç«‹å³è§¦å‘
    setTimeout(() => document.addEventListener('click', closeListener), 0);
  }
}

// æ ¸å¿ƒï¼šæ”¹å˜è§†å›¾æ¨¡å¼
function changeViewMode(mode) {
  currentViewMode = mode;
  const contentEl = document.getElementById('articleContent');
  const btnIcon = document.querySelector('#btnViewSwitch i');
  
  // 1. è®¾ç½® CSS ç±»
  if (mode === 'gallery') {
    contentEl.classList.remove('view-blog');
    contentEl.classList.add('view-gallery');
    btnIcon.className = 'fa-solid fa-images'; // å›¾æ ‡å˜æ›´ä¸ºå›¾ç‰‡
  } else {
    contentEl.classList.remove('view-gallery');
    contentEl.classList.add('view-blog');
    btnIcon.className = 'fa-solid fa-newspaper'; // å›¾æ ‡å˜æ›´ä¸ºæŠ¥çº¸/æ–‡ç« 
  }
  
  // 2. æ›´æ–°ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
  document.querySelectorAll('.dropdown-item').forEach(el => el.classList.remove('active'));
  document.getElementById(mode === 'blog' ? 'viewOptionBlog' : 'viewOptionGallery').classList.add('active');
  
  // 3. è®°ä½ç”¨æˆ·åå¥½ (å¯é€‰ï¼Œè¿™é‡Œä»…é’ˆå¯¹å•æ¬¡ä¼šè¯æˆ–å•ç¯‡æ–‡ç« )
  // localStorage.setItem('rss_view_pref', mode); 
}

// æ™ºèƒ½æ£€æµ‹æ¨¡å¼
function autoDetectViewMode(htmlContent) {
  // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥åˆ†æå†…å®¹
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = htmlContent;
  
  const imgs = tempDiv.querySelectorAll('img');
  const videos = tempDiv.querySelectorAll('video, iframe');
  const text = tempDiv.innerText.replace(/\s/g, ''); // å»é™¤ç©ºç™½çš„çº¯æ–‡æœ¬
  
  const mediaCount = imgs.length + videos.length;
  const textLen = text.length;

  // ç®—æ³•ï¼šå¦‚æœåª’ä½“è¶…è¿‡ 5 ä¸ªï¼Œä¸”å¹³å‡æ¯å¼ å›¾é…æ–‡å°‘äº 100 å­—ï¼Œå€¾å‘äºç”»å»Šæ¨¡å¼
  // æˆ–è€…ï¼šå¦‚æœå…¨æ˜¯å›¾æ²¡æœ‰å­—
  if (mediaCount >= 4 && (textLen / mediaCount) < 150) {
    return 'gallery';
  }
  return 'blog';
}

// ä¿®æ”¹åŸæœ‰çš„ renderArticleBody å‡½æ•°
function renderArticleBody(art) {
  document.getElementById('placeholder').style.display='none';
  const contentEl = document.getElementById('articleContent');

  // 1. å¼ºåˆ¶æ˜¾ç¤ºæ™®é€šæ–‡ç« å®¹å™¨
  contentEl.style.display = 'block';
  
  // 2. å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶æ¢å¤å¤´éƒ¨æ˜¾ç¤º
  document.getElementById('articleHeader').style.display = 'block';
  document.getElementById('aiSummarySection').style.display = 'none'; // é»˜è®¤éšè—æ€»ç»“ï¼Œä¸‹é¢æœ‰åˆ¤æ–­ä¼šå¼€

  // 3. å…³é”®ä¿®å¤ï¼šç§»é™¤æ‚å¿—è§†å›¾çš„ä¸“ç”¨ç±»ï¼Œé˜²æ­¢æ ·å¼æ±¡æŸ“
  contentEl.classList.remove('view-magazine');
  
  // 4. æ¢å¤ä¹‹å‰çš„è§†å›¾æ¨¡å¼ (Blog æˆ– Gallery)
  // ç¡®ä¿ currentViewMode å˜é‡å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º 'blog'
  if (typeof currentViewMode === 'undefined') currentViewMode = 'blog';
  changeViewMode(currentViewMode);
  
  document.getElementById('artDate').innerText = art.date;
  document.getElementById('artLink').href = art.link;
  const summarySec = document.getElementById('aiSummarySection');
  const bodyEl = document.getElementById('articleBody');
  const titleEl = document.getElementById('artTitle');

  // AI æ€»ç»“æ˜¾ç¤ºé€»è¾‘
  if (art.aiSummary) { 
    summarySec.style.display = 'block'; 
    document.getElementById('aiSummaryContent').innerHTML = art.aiSummary; 
  } else { 
    summarySec.style.display = 'none'; 
  }

  // æ¸²æŸ“å†…å®¹
  let contentHtml = art.desc;
  let titleText = art.title;
  
  if (art.showingTranslation && art.aiTranslation) {
    contentHtml = art.aiTranslation;
    titleText = art.aiTitleTranslation || art.title;
    updateTranslateBtnState(true);
  } else {
    updateTranslateBtnState(false);
  }

  bodyEl.innerHTML = contentHtml;
  titleEl.innerText = titleText;

  // --- [å…³é”®] è‡ªåŠ¨æ£€æµ‹å¹¶åº”ç”¨è§†å›¾æ¨¡å¼ ---
  // 1. å…ˆæ£€æµ‹é€‚åˆä»€ä¹ˆæ¨¡å¼
  const suggestedMode = autoDetectViewMode(contentHtml);
  // 2. åº”ç”¨æ¨¡å¼ (å¦‚æœä¸å¸Œæœ›æ¯æ¬¡ç‚¹å‡»æ–‡ç« éƒ½é‡ç½®ï¼Œå¯ä»¥å»æ‰è¿™è¡Œï¼Œåªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ£€æµ‹)
  changeViewMode(suggestedMode);

  // æ»šåŠ¨å›é¡¶éƒ¨
  document.getElementById('articleScrollArea').scrollTop = 0;
}
/* ================== OPML Import Logic (å¢å¼ºç‰ˆ) ================== */
function handleOpmlImport(input) {
  const file = input.files[0];
  if (!file) return;

  // UI åé¦ˆ
  const labelSpan = input.parentElement.querySelector('span');
  const originalText = labelSpan.innerText;
  labelSpan.innerText = t('modals.importing'); // "æ­£åœ¨å¯¼å…¥..."

  const reader = new FileReader();
  
  // 1. è¯»å–å®Œæˆåçš„å›è°ƒ
  reader.onload = async (e) => {
    try {
      let text = e.target.result;
      const parser = new DOMParser();
      
      // --- ç¬¬ä¸€æ¬¡å°è¯•è§£æ ---
      let doc = parser.parseFromString(text, "text/xml");
      
      // --- å¦‚æœå¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤ (é’ˆå¯¹ & ç¬¦å·) ---
      if (doc.querySelector('parsererror')) {
        console.warn("ç¬¬ä¸€æ¬¡è§£æå¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤éæ³•å­—ç¬¦ (& -> &amp;)...");
        // æ­£åˆ™ï¼šå°†æ‰€æœ‰åé¢ä¸æ˜¯å®ä½“å­—ç¬¦çš„ & æ›¿æ¢ä¸º &amp;
        text = text.replace(/&(?!(amp|lt|gt|quot|apos);)/g, '&amp;');
        doc = parser.parseFromString(text, "text/xml");
      }

      // --- å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼ŒæŠ›å‡ºè¯¦ç»†é”™è¯¯ ---
      const errorNode = doc.querySelector('parsererror');
      if (errorNode) {
        throw new Error(errorNode.textContent || "XML format violation");
      }

      // --- è§£ææˆåŠŸï¼Œå¼€å§‹æå–æ•°æ® ---
      // æŸ¥æ‰¾æ‰€æœ‰ xmlUrl å±æ€§ (å…¼å®¹ rss, outline ç­‰æ ‡ç­¾)
      const outlines = doc.querySelectorAll('[xmlUrl]');
      let count = 0;

      outlines.forEach(node => {
        const url = node.getAttribute('xmlUrl');
        // ä¼˜å…ˆå– titleï¼Œå¦‚æœæ²¡æœ‰åˆ™å– textï¼Œæœ€åå– 'Untitled'
        const title = node.getAttribute('title') || node.getAttribute('text') || 'Untitled';
        
        if (!url) return;

        // æŸ¥é‡ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = state.allFeeds.some(f => f.url === url);
        if (!exists) {
          // è‡ªåŠ¨åˆ¤æ–­ç±»å‹
          let type = 'url';
          if (url.includes('rsshub') || (url.startsWith('/') && !url.startsWith('http'))) {
            type = 'rsshub';
          }

          state.userFeeds.push({
            title: title,
            url: url,
            type: type
          });
          count++;
        }
      });

      if (count > 0) {
        saveUserFeeds();
        updateAllFeeds();
        // æç¤ºæˆåŠŸ
        alert(t('modals.opml_success').replace('{n}', count));
        closeModal('addFeedModal');
        renderSidebar();
        // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­æ–‡ç« ï¼ŒåŠ è½½æ–°å¯¼å…¥çš„ç¬¬ä¸€ä¸ª
        if (state.activeIdx === -1) loadFeed(state.allFeeds.length - count);
      } else {
        alert("æœªå‘ç°æœ‰æ•ˆçš„æ–°è®¢é˜…æº (No valid feeds found)");
      }

    } catch (err) {
      console.error("OPML Import Error:", err);
      // å¼¹çª—æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
      alert(`${t('modals.opml_error')}\n\né”™è¯¯è¯¦æƒ…: ${err.message.slice(0, 100)}`);
    } finally {
      input.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
      labelSpan.innerText = originalText;
    }
  };
  
  // 2. å¼€å§‹è¯»å– (é»˜è®¤ UTF-8)
  reader.readAsText(file);
}
// æ”¾åœ¨ renderSidebar å‡½æ•°é™„è¿‘
function filterFeeds(text) {
  const term = text.toLowerCase().trim();
  const items = document.querySelectorAll('.feed-item');
  
  items.forEach(item => {
    // è·å–è®¢é˜…æºåç§°
    const name = item.querySelector('.feed-name').innerText.toLowerCase();
    // å¦‚æœåŒ…å«å…³é”®è¯ï¼Œæ˜¾ç¤ºï¼›å¦åˆ™éšè—
    if (name.includes(term)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}
/* ================== RSS Site Explore Logic ================== */

// 1. åŠ è½½æ•°æ®
async function loadFeaturedRss() {
  const container = document.getElementById('rssSiteList');
  try {
    const res = await fetch('./featured_rss.json');
    if (!res.ok) throw new Error("Failed to load list");
    state.featuredRss = await res.json();
    renderRssSites(state.featuredRss);
  } catch (e) {
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#f55">Error: ${e.message}</div>`;
  }
}

// 2. æ¸²æŸ“ RSS ç«™ç‚¹å¡ç‰‡ (é€‚é…åŒè¯­)
function renderRssSites(list) {
  const container = document.getElementById('rssSiteList');
  container.innerHTML = '';
  
  if (list.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#999; grid-column:1/-1">No results found</div>`;
    return;
  }

  const isZh = state.settings.lang === 'zh';

  list.forEach(site => {
    // === [ä¿®æ”¹] æ™ºèƒ½è·å–æè¿°æ–‡æœ¬ ===
    // é€»è¾‘ï¼šä¼˜å…ˆå–å½“å‰è¯­è¨€ -> å…¶æ¬¡å–å¦ä¸€ç§è¯­è¨€ -> å†æ¬¡å–æ—§å­—æ®µ -> æœ€åé»˜è®¤æ–‡æœ¬
    const descText = (isZh ? site.description_zh : site.description_en) || 
                     (isZh ? site.description_en : site.description_zh) || 
                     site.description || 
                     'No description available.';

    const card = document.createElement('div');
    card.className = 'rss-card';
    const iconUrl = `https://s2.googleusercontent.com/s2/favicons?domain_url=${new URL(site.url).origin}`;
    
    card.innerHTML = `
      <div class="rss-card-header">
        <img src="${iconUrl}" style="width:16px;height:16px;border-radius:2px;" onerror="this.style.opacity=0">
        <div class="rss-card-title" title="${site.name}">${site.name}</div>
        ${site.category ? `<span class="rss-card-tag">${site.category}</span>` : ''}
      </div>
      <!-- ä½¿ç”¨è®¡ç®—å¥½çš„ descText -->
      <div class="rss-card-desc" title="${descText}">${descText}</div>
      <button class="rss-card-btn" onclick="selectRssSite('${site.url}', '${site.name}')">
        <i class="fa-solid fa-plus"></i> ${t('modals.btn_use')}
      </button>
    `;
    container.appendChild(card);
  });
}

// 3. æœç´¢è¿‡æ»¤ (é€‚é…åŒè¯­å­—æ®µ)
function filterRssSites() {
  const term = document.getElementById('rssSiteSearch').value.toLowerCase();
  
  const filtered = state.featuredRss.filter(site => {
    // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è½¬å°å†™
    const safeLower = (str) => (str || '').toLowerCase();

    // === [ä¿®æ”¹] åŒæ—¶æ£€ç´¢ä¸­è‹±æ–‡å­—æ®µ ===
    return safeLower(site.name).includes(term) || 
           safeLower(site.description_zh).includes(term) || 
           safeLower(site.description_en).includes(term) ||
           safeLower(site.description).includes(term) || // å…¼å®¹æ—§å­—æ®µ
           safeLower(site.category).includes(term);
  });
  
  renderRssSites(filtered);
}

// 4. é€‰æ‹©ç«™ç‚¹ (å¤ç”¨â€œæ·»åŠ è®¢é˜…â€æ¨¡æ€æ¡†)
function selectRssSite(url, name) {
  closeModal('rssSiteModal');
  openModal('addFeedModal');
  
  document.getElementById('feedInput').value = url;
  document.getElementById('feedNameInput').value = name;
  document.getElementById('feedType').value = 'url'; // è¿™ç±»é€šå¸¸æ˜¯æ™®é€š URL
  
  // è§†è§‰åé¦ˆ
  const input = document.getElementById('feedInput');
  input.style.transition = 'background 0.2s';
  input.style.background = '#e6fffa';
  setTimeout(() => input.style.background = '#fafafa', 500);
}
/* ================== AI Magazine Logic ================== */
// --- [æ–°å¢] æ‰“å¼€é…ç½®çª—å£å¹¶æ¸²æŸ“è®¢é˜…æº ---
function openMagConfig() {
  closeModal('magazineListModal');
  openModal('magazineConfigModal');
  
  // æ‰§è¡Œä¸€æ¬¡å…¨å±€ UI ç¿»è¯‘æ›´æ–°ï¼Œç¡®ä¿ Modal é‡Œçš„ data-i18n ç”Ÿæ•ˆ
  updateUI(); 

  document.getElementById('magConfigHours').value = state.settings.magazineHours;
  
  const container = document.getElementById('magSourceList');
  container.innerHTML = '';
  
  state.allFeeds.forEach((feed, index) => {
    let iconUrl = feed.type === 'rsshub' ? './RSSHub_logo.png' : `https://s2.googleusercontent.com/s2/favicons?domain_url=${new URL(feed.url).origin}`;
    
    const label = document.createElement('label');
    label.className = 'source-check-item';
    label.innerHTML = `
      <input type="checkbox" class="mag-source-cb" value="${index}" checked>
      <img src="${iconUrl}" onerror="this.style.opacity=0">
      <span class="source-name">${getTrTitle(feed.title)}</span>
    `;
    label.querySelector('input').addEventListener('change', updateMagSelCount);
    container.appendChild(label);
  });

  // åˆå§‹åŒ–è®¡æ•°å™¨æ˜¾ç¤º
  updateMagSelCount();
}

// --- [æ–°å¢] å…¨é€‰/åé€‰ä¸è®¡æ•° ---
function toggleMagSources(select) {
  document.querySelectorAll('.mag-source-cb').forEach(cb => cb.checked = select);
  updateMagSelCount();
}

function updateMagSelCount() {
  const count = document.querySelectorAll('.mag-source-cb:checked').length;
  // ä½¿ç”¨ t() å‡½æ•°è·å–ç¿»è¯‘ï¼Œå¹¶æ›¿æ¢å ä½ç¬¦ {n}
  const translatedText = t('modals.mag_config_selected').replace('{n}', count);
  document.getElementById('magSelInfo').innerHTML = translatedText;
}

// --- [ä¿®æ”¹] å¼€å§‹ç”Ÿæˆæµç¨‹ (æ ¸å¿ƒä¿®æ”¹) ---
async function startMagazineGeneration() {
  // 1. è·å–é€‰ä¸­çš„è®¢é˜…æºç´¢å¼•
  const checkboxes = document.querySelectorAll('.mag-source-cb:checked');
  if (checkboxes.length === 0) {
    alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¢é˜…æºï¼");
    return;
  }
  
  // 2. è·å–ä¸´æ—¶çš„æ—¶é—´è®¾ç½® (ä¸ä¿å­˜åˆ°å…¨å±€ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©ä¿å­˜)
  const hours = parseInt(document.getElementById('magConfigHours').value) || 24;
  
  closeModal('magazineConfigModal');
  openModal('magazineProgressModal');
  document.getElementById('btnStopMag').innerText = "Stop";
  
  isGeneratingMag = true;
  stopGenFlag = false;
  
  const logEl = document.getElementById('magLog');
  const taskEl = document.getElementById('magCurrentTask');
  const liveEl = document.getElementById('magLiveStream');
  
  const log = (msg) => { 
    const div = document.createElement('div'); 
    div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`; 
    logEl.appendChild(div); 
    logEl.scrollTop = logEl.scrollHeight; 
  };
  
  logEl.innerHTML = ''; 
  liveEl.innerHTML = '';
  
  try {
    // A. æ”¶é›†æ–‡ç«  (ä»…ä»é€‰ä¸­çš„æº)
    log(t('modals.magazine_process_fetching'));
    const cutoff = Date.now() - (hours * 60 * 60 * 1000);
    let candidates = [];
    
    // æ„å»ºå¾…æ‰«æåˆ—è¡¨
    const indices = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // éå†é€‰ä¸­çš„è®¢é˜…æº
    for (let i = 0; i < indices.length; i++) {
      if (stopGenFlag) break;
      const feedIdx = indices[i];
      const feed = state.allFeeds[feedIdx]; // è·å–çœŸå®çš„ feed å¯¹è±¡
      
      taskEl.innerText = `Fetching (${i+1}/${indices.length}): ${getTrTitle(feed.title)}`;
      
      try {
        const res = await fetchRSS(feed, false); 
        const freshItems = res.data.filter(item => new Date(item.date).getTime() > cutoff);
        freshItems.forEach(item => item.sourceTitle = getTrTitle(feed.title));
        candidates.push(...freshItems);
        log(`- ${getTrTitle(feed.title)}: Found ${freshItems.length} new articles.`);
      } catch (e) {
        log(`x Failed to fetch ${getTrTitle(feed.title)}`);
      }
    }
    
    // ... ä»¥ä¸‹ä»£ç ä¿æŒåŸæ ·ï¼Œç›´æ¥å¤åˆ¶åŸæ¥çš„ startMagazineGeneration å‡½æ•°ä¸­ä» "if (stopGenFlag) throw new Error..." å¼€å§‹çš„éƒ¨åˆ† ...
    // ä¸ºäº†å®Œæ•´æ€§ï¼Œæˆ‘åœ¨è¿™é‡Œç»§ç»­å†™å®Œåç»­é€»è¾‘:
    
    if (stopGenFlag) throw new Error("Stopped by user.");
    
    // å»é‡
    const uniqueMap = new Map();
    candidates.forEach(item => uniqueMap.set(item.link, item));
    candidates = Array.from(uniqueMap.values());
    
    // æ’åº
    candidates.sort((a,b) => new Date(b.date) - new Date(a.date));
    
    if (candidates.length === 0) {
      log("No articles found in this time range.");
      document.getElementById('btnStopMag').innerText = "Close";
      return;
    }
    
    log(t('modals.magazine_process_analyzing') + ` Total: ${candidates.length}`);
    
    // B. é€ä¸ªæ€»ç»“
    const summarizedArticles = [];
    
    for (let i = 0; i < candidates.length; i++) {
      if (stopGenFlag) break;
      const art = candidates[i];
      taskEl.innerText = `${i+1}/${candidates.length}: ${art.title}`;
      
      let cachedMeta = await dbHelper.get('article_meta', art.link) || {};
      let summaryText = "";
      let titleTransText = ""; 

      // 1. æ ‡é¢˜ç¿»è¯‘é€»è¾‘
      if (cachedMeta.titleTranslation) {
        titleTransText = cachedMeta.titleTranslation;
        log(`> [Title] Loaded from cache`);
      } else {
        log(`> [Title] Translating...`);
        liveEl.innerText = "Translating Title...";
        await new Promise((resolve) => {
          let buf = "";
          streamAIRequest(
            `Translate the title to ${state.settings.targetLang}. Return ONLY the translation.`,
            art.title,
            (c) => { buf += c; },
            async () => {
              titleTransText = buf.trim();
              cachedMeta = await dbHelper.get('article_meta', art.link) || {};
              cachedMeta.id = art.link;
              cachedMeta.titleTranslation = titleTransText;
              cachedMeta.timestamp = Date.now();
              await dbHelper.put('article_meta', cachedMeta);
              resolve();
            }
          ).catch(() => resolve());
        });
      }

      // 2. æ€»ç»“é€»è¾‘
      if (cachedMeta.summary) {
        log(`> [Summary] Loaded from cache`);
        summaryText = cachedMeta.summary;
      } else {
        log(`${t('modals.magazine_process_article')} ${art.title.substr(0,15)}...`);
        liveEl.innerText = "AI Summarizing...";
        const tempDiv = document.createElement('div'); tempDiv.innerHTML = art.desc;
        const rawText = tempDiv.innerText.replace(/\s+/g, ' ').slice(0, 3000);
        
        await new Promise((resolve) => {
          let buffer = "";
          streamAIRequest(
            `Summarize in 3 bullet points in ${state.settings.targetLang}. Be concise.`,
            rawText,
            (chunk) => { if(stopGenFlag) return; buffer += chunk; liveEl.innerText = buffer; },
            async () => {
               const md = window.markdownit();
               const htmlSummary = md.render(buffer);
               cachedMeta = await dbHelper.get('article_meta', art.link) || {};
               cachedMeta.id = art.link;
               cachedMeta.summary = htmlSummary;
               cachedMeta.timestamp = Date.now();
               await dbHelper.put('article_meta', cachedMeta);
               summaryText = htmlSummary;
               resolve();
            }
          ).catch(() => resolve());
        });
      }
      
      summarizedArticles.push({
        title: titleTransText || art.title,
        originalTitle: art.title,
        link: art.link,
        date: art.date,
        source: art.sourceTitle,
        summary: summaryText,
        image: art.image
      });
      
      await new Promise(r => setTimeout(r, 500));
    }
 
    if (stopGenFlag) throw new Error("Stopped.");

    // C. ä¿å­˜å’ŒæŸ¥çœ‹
    const magId = Date.now();
    const magazineData = {
      id: magId,
      title: `AI Digest #${new Date().toLocaleDateString()}`,
      created: Date.now(),
      articleCount: summarizedArticles.length,
      articles: summarizedArticles
    };
    
    await dbHelper.put('magazines', magazineData);
    log(t('modals.magazine_process_done'));
    taskEl.innerText = "Completed!";
    document.getElementById('btnStopMag').innerText = "Close";
    closeModal('magazineProgressModal');
    viewMagazine(magId);

  } catch(e) {
    log(`Error: ${e.message}`);
    document.getElementById('btnStopMag').innerText = "Close";
  } finally {
    isGeneratingMag = false;
  }
}


let isGeneratingMag = false;
let stopGenFlag = false;

// 1. åŠ è½½å†å²æ‚å¿—åˆ—è¡¨
async function loadMagazineList() {
  const container = document.getElementById('magazineContainer');
  container.innerHTML = '<div class="spinner"></div>';
  try {
    const db = await dbHelper.open();
    const tx = db.transaction('magazines', 'readonly');
    const req = tx.objectStore('magazines').getAll();
    req.onsuccess = () => {
      const list = req.result.sort((a,b) => b.id - a.id); // æŒ‰æ—¶é—´å€’åº
      if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#999">${t('modals.magazine_empty')}</div>`;
        return;
      }
      container.innerHTML = '';
      list.forEach(mag => {
        const div = document.createElement('div');
        div.className = 'mag-item';
        div.innerHTML = `
          <div class="mag-info" onclick="viewMagazine(${mag.id})">
             <h4>${mag.title}</h4>
             <p>${new Date(mag.id).toLocaleString()} Â· ${mag.articleCount} Articles</p>
          </div>
          <div class="mag-actions">
            <button class="btn-icon" onclick="deleteMagazine(${mag.id}, event)" style="color:#ff4d4f"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
        container.appendChild(div);
      });
    };
  } catch(e) { console.error(e); }
}

function stopMagazineGen() {
  if (isGeneratingMag) {
    stopGenFlag = true;
    document.getElementById('magLog').innerHTML += `<div>!!! USER STOPPED !!!</div>`;
  } else {
    closeModal('magazineProgressModal');
  }
}

// 3. æŸ¥çœ‹æ‚å¿— (æ¸²æŸ“è§†å›¾)
async function viewMagazine(id) {
  closeModal('magazineListModal');
  navTo('content'); // åˆ‡åˆ°å†…å®¹é¡µ
  
  const contentEl = document.getElementById('articleContent');
  const scrollArea = document.getElementById('articleScrollArea');
  const db = await dbHelper.open();
  const tx = db.transaction('magazines', 'readonly');
  const req = tx.objectStore('magazines').get(id);
  
  req.onsuccess = () => {
    const mag = req.result;
    if (!mag) return alert("Magazine not found");
    
    document.getElementById('placeholder').style.display = 'none';
    contentEl.style.display = 'block';
    
    // åˆ‡æ¢åˆ°ç‰¹æ®Šçš„æ‚å¿— CSS æ¨¡å¼
    contentEl.className = ''; // æ¸…é™¤ blog/gallery
    contentEl.classList.add('view-magazine');
    
    // éšè—æ™®é€š Headerï¼Œä½¿ç”¨æ‚å¿—å°é¢
    document.getElementById('articleHeader').style.display = 'none';
    document.getElementById('aiSummarySection').style.display = 'none';
    
    // æ„å»º HTML
    let tocHtml = `<div class="magazine-toc"><h3>${t('content.magazine_toc')}</h3>`;
    let bodyHtml = `<div class="magazine-cover">
      <div class="magazine-title">${t('content.magazine_cover_title')}</div>
      <div class="magazine-date">${new Date(mag.created).toLocaleDateString()} Â· ${mag.articles.length} Stories</div>
    </div>`;
    
    // ç”Ÿæˆç›®å½•å’Œæ­£æ–‡
    let articlesHtml = '';
    mag.articles.forEach((art, idx) => {
      const anchor = `mag-art-${idx}`;
      tocHtml += `<a class="toc-link" style="cursor: pointer;" onclick="document.getElementById('${anchor}').scrollIntoView({behavior:'smooth'})">
        ${idx+1}. ${art.title}
      </a>`;
      articlesHtml += `
        <div id="${anchor}" class="mag-article">
          <div class="mag-article-title"><a href="${art.link}" target="_blank" style="text-decoration:none; color:inherit">${art.title}</a></div>
          ${(art.originalTitle && art.originalTitle !== art.title) ? 
            `<div style="font-size:14px; color:#888; margin-bottom:5px;">${art.originalTitle}</div>` : ''}
          <div class="mag-article-meta">
            <span>${art.source}</span> Â· <span>${art.date}</span>
             <a href="${art.link}" target="_blank" style="margin-left:10px; color:var(--accent)"><i class="fa-solid fa-external-link-alt"></i></a>
          </div>
          ${art.image ? `<img src="${art.image}" style="max-width:100%; border-radius:6px; margin-bottom:15px; max-height:300px; object-fit:cover;">` : ''}
          <div class="mag-article-summary markdown-body">
            ${art.summary || '<p style="color:#999;font-style:italic">No summary available.</p>'}
          </div>
        </div>
      `;
    });
    
    tocHtml += `</div>`;
    
    document.getElementById('articleBody').innerHTML = tocHtml + articlesHtml;
    scrollArea.scrollTop = 0;
  };
}

// 4. åˆ é™¤æ‚å¿—
async function deleteMagazine(id, e) {
  e.stopPropagation();
  if(!confirm(t('alerts.delete_confirm'))) return;
  const db = await dbHelper.open();
  const tx = db.transaction('magazines', 'readwrite');
  tx.objectStore('magazines').delete(id);
  tx.oncomplete = () => loadMagazineList();
}

/* ================== End AI Magazine Logic ================== */

/* ================== [æ–°å¢] TTS æœ—è¯»åŠŸèƒ½é€»è¾‘ ================== */

// 1. æ–‡æœ¬æ¸…æ´—å·¥å…·å‡½æ•°ï¼šç§»é™¤å›¾ç‰‡ã€è§†é¢‘ã€é“¾æ¥ã€AIæ€»ç»“ç­‰
function cleanTextForTTS(element, isMagazineMode = false) {
  // å…‹éš†èŠ‚ç‚¹ä»¥é¿å…ä¿®æ”¹é¡µé¢æ˜¾ç¤º
  const clone = element.cloneNode(true);

  // ç§»é™¤æ‰€æœ‰ä¸éœ€è¦çš„åª’ä½“æ ‡ç­¾
  const mediaTags = ['img', 'video', 'audio', 'iframe', 'svg', 'canvas', 'noscript', 'script', 'style'];
  mediaTags.forEach(tag => {
    clone.querySelectorAll(tag).forEach(el => el.remove());
  });

  // ç§»é™¤ç‰¹å®šçš„ CSS ç±»ï¼ˆå¦‚ä»£ç å—è¡Œå·ã€éšè—å…ƒç´ ç­‰ï¼‰
  // å¦‚æœä¸æ˜¯æ‚å¿—æ¨¡å¼ï¼Œç§»é™¤æ™®é€šæ–‡ç« çš„ AI æ€»ç»“åŒºåŸŸ
  if (!isMagazineMode) {
    clone.querySelectorAll('#aiSummarySection').forEach(el => el.remove());
  }

  // ç§»é™¤æ‰€æœ‰é“¾æ¥çš„ href (é˜²æ­¢è¯»å‡º http://...)ï¼Œä¿ç•™æ–‡æœ¬
  // æˆ–è€…ç›´æ¥ç§»é™¤æ•´ä¸ªé“¾æ¥èŠ‚ç‚¹ï¼Ÿæ ¹æ®éœ€æ±‚æ˜¯"ç§»é™¤ç½‘é¡µé“¾æ¥"ï¼Œé€šå¸¸æŒ‡ä¸è¦è¯»å‡ºURL
  // è¿™é‡Œæˆ‘ä»¬ä¿ç•™é“¾æ¥çš„æ–‡æœ¬ï¼Œä½†ç¨åä¼šç”¨æ­£åˆ™å†æ¬¡æ¸…æ´—æ–‡æœ¬ä¸­çš„ URL
  
  let text = "";

  if (isMagazineMode) {
    // === æ‚å¿—æ¨¡å¼ç‰¹æ®Šå¤„ç† ===
    // ç§»é™¤ç›®å½•
    clone.querySelectorAll('.magazine-toc').forEach(el => el.remove());
    clone.querySelectorAll('.magazine-cover').forEach(el => el.remove());

    // åªæå–æ¯ä¸€ä¸ªæ–‡ç« å—çš„ æ ‡é¢˜ å’Œ æ€»ç»“
    const articles = clone.querySelectorAll('.mag-article');
    const parts = [];
    
    // å¼€åœºç™½
    // parts.push(t('content.magazine_cover_title')); 

    articles.forEach((art, idx) => {
      const titleEl = art.querySelector('.mag-article-title');
      const summaryEl = art.querySelector('.mag-article-summary');
      
      if (titleEl && summaryEl) {
        // ç¬¬Xç¯‡ï¼šæ ‡é¢˜ã€‚å†…å®¹...
        parts.push(`${t('content.article_prefix') || 'Article'} ${idx + 1}.`);
        parts.push(titleEl.innerText.trim());
        parts.push(summaryEl.innerText.trim());
      }
    });
    text = parts.join('\n\n');

  } else {
    // === æ™®é€šæ–‡ç« æ¨¡å¼ ===
    // æå–æ ‡é¢˜ (å¦‚æœæœ‰ id="artTitle" çš„è¯ï¼Œé€šå¸¸ä¼ å…¥çš„ element æ˜¯ bodyï¼Œæ ‡é¢˜å•ç‹¬ä¼ )
    // è¿™é‡Œå‡è®¾ä¼ å…¥çš„æ˜¯ bodyï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ‹¼æ¥æ ‡é¢˜
    const title = document.getElementById('artTitle') ? document.getElementById('artTitle').innerText : '';
    const bodyText = clone.innerText;
    text = title + "\n\n" + bodyText;
  }

  // === é€šç”¨æ–‡æœ¬æ¸…æ´— ===
  // 1. ç§»é™¤ Markdown å›¾ç‰‡æ ‡è®° ![alt](url) æˆ– HTML <img>ç•™ä¸‹çš„ç—•è¿¹
  // 2. ç§»é™¤æ‰€æœ‰ URL é“¾æ¥æ–‡æœ¬ (http://xxx, https://xxx)
  text = text.replace(/(https?:\/\/[^\s]+)/g, ''); 
  
  // 3. ç§»é™¤å¤šä½™çš„ç©ºè¡Œå’Œç©ºç™½
  text = text.replace(/\n\s*\n/g, '\n').trim();

  return text;
}

// 2. é€‰ä¸­æœ—è¯»
function actionReadSelection() {
  const selection = window.getSelection().toString().trim();
  if (!selection) return;

  // ç®€å•æ¸…æ´—é€‰ä¸­åçš„æ–‡æœ¬ä¸­çš„ URL
  const cleanText = selection.replace(/(https?:\/\/[^\s]+)/g, '');
  
  sendTextToTTS(cleanText);
  
  // éšè—å·¥å…·æ 
  document.getElementById('selectionToolbar').style.display = 'none';
}

// 3. å…¨æ–‡æœ—è¯»
function actionReadFull(btn) {
  const contentEl = document.getElementById('articleContent');
  const isMagazine = contentEl.classList.contains('view-magazine');
  const icon = btn.querySelector('i');

  // å¦‚æœæ­£åœ¨æœ—è¯»ï¼ˆè¿™é‡Œåšä¸€ä¸ªç®€å•çš„çŠ¶æ€åˆ‡æ¢ï¼Œå®é™…ä¸Šåç«¯æ‰æ˜¯æ’­æ”¾å™¨ï¼‰
  // æˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ª stop æŒ‡ä»¤ï¼Œæˆ–è€…å†æ¬¡ç‚¹å‡»è§†ä¸ºé‡æ–°å¼€å§‹
  if (btn.classList.contains('reading')) {
    // å‘é€åœæ­¢æŒ‡ä»¤
    if (state.ws && state.ws.readyState === WebSocket.OPEN) {
      state.ws.send(JSON.stringify({ type: 'stop_read' }));
    }
    btn.classList.remove('reading');
    btn.classList.remove('active');
    icon.className = 'fa-solid fa-headphones';
    return;
  }

  // å¼€å§‹å‡†å¤‡æ–‡æœ¬
  let textToRead = "";
  
  if (isMagazine) {
    // æ‚å¿—æ¨¡å¼ï¼šä¼ å…¥æ•´ä¸ª contentEl è¿›è¡Œè§£æ
    textToRead = cleanTextForTTS(document.getElementById('articleBody'), true);
  } else {
    // æ™®é€šæ¨¡å¼ï¼šä¼ å…¥ articleBody
    textToRead = cleanTextForTTS(document.getElementById('articleBody'), false);
  }

  if (!textToRead) {
    alert("æ²¡æœ‰å¯æœ—è¯»çš„å†…å®¹");
    return;
  }

  // å‘é€
  sendTextToTTS(textToRead);

  // UI çŠ¶æ€æ›´æ–°
  btn.classList.add('reading');
  btn.classList.add('active'); // ä¿æŒé«˜äº®
  icon.className = 'fa-solid fa-stop'; // å˜ä¸ºåœæ­¢å›¾æ ‡
  
  // ç®€å•çš„è¶…æ—¶é‡ç½® UI (å¯é€‰ï¼Œé˜²æ­¢ä¸€ç›´æ˜¾ç¤ºåœæ­¢çŠ¶æ€)
  // setTimeout(() => {
  //   btn.classList.remove('reading');
  //   btn.classList.remove('active');
  //   icon.className = 'fa-solid fa-headphones';
  // }, 5000); 
}

// 4. å‘é€ WebSocket æŒ‡ä»¤
function sendTextToTTS(text) {
  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
    alert("WebSocket æœªè¿æ¥ï¼Œæ— æ³•æœ—è¯»");
    return;
  }
  
  state.ws.send(JSON.stringify({
    type: 'start_read',
    data: { text: text }
  }));
}
</script>
</body>
</html>