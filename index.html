<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="referrer" content="no-referrer" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AI RSS Reader Pro</title>
<link rel="stylesheet" href="../../fontawesome/css/all.min.css">
<style>
/* ================== 基础样式 ================== */
:root {
  --bg-sidebar: #f7f7f7; --bg-list: #fff; --bg-content: #fff;
  --border: #e0e0e0; --text-main: #333; --text-sub: #666;
  --accent: #ff6b35; --hover: #f0f0f0; --header-h: 50px;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
body { height: 100vh; display: flex; overflow: hidden; color: var(--text-main); background: #fff; }


/* 布局 */
.layout-col { height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
#sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); flex-shrink: 0; z-index: 3; }
#articleList { width: 350px; background: var(--bg-list); border-right: 1px solid var(--border); flex-shrink: 0; z-index: 2; }
#contentView { flex: 1; background: var(--bg-content); position: relative; z-index: 1; scroll-behavior: smooth; }

/* 顶部栏 */
.header-bar {
height: var(--header-h); padding: 0 15px; border-bottom: 1px solid var(--border);
display: flex; align-items: center; justify-content: space-between;
background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
position: sticky; top: 0; z-index: 10; font-weight: 600; font-size: 15px;flex-shrink: 0; 
}
.btn-icon { background: none; border: none; cursor: pointer; color: var(--text-sub); font-size: 16px; padding: 8px; border-radius: 6px; transition: .2s; }
.btn-icon:hover { color: var(--accent); background: rgba(0,0,0,0.05); }

/* 订阅列表项 */
.feed-item {
padding: 10px 12px; margin: 4px 10px; border-radius: 6px; cursor: pointer;
display: flex; align-items: center; gap: 10px; font-size: 14px; position: relative;
transition: background .2s;
}
.feed-item:hover { background: rgba(0,0,0,0.05); }
.feed-item.active { background: #e6e6e6; font-weight: 600; }
.feed-icon { width: 16px; height: 16px; border-radius: 3px; object-fit: cover; flex-shrink: 0; }
.feed-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 20px; }

/* 删除按钮 & 默认源锁定状态 */
.btn-delete {
position: absolute; right: 5px; opacity: 0; color: #999; border:none;
background:none; cursor:pointer; padding: 4px; transition: opacity .2s; z-index: 2;
}
.feed-item:hover .btn-delete { opacity: 1; }
.btn-delete:hover { color: #ff4d4f; }
.icon-locked {
position: absolute; right: 8px; color: #ccc; font-size: 12px; opacity: 0.5;
}

/* 文章卡片 */
.article-card { padding: 18px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .2s; }
.article-card:hover { background: var(--hover); }
.article-card.active { border-left: 4px solid var(--accent); background: var(--hover); padding-left: 16px; }
.article-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; line-height: 1.4; color: #222; }
.article-meta { font-size: 12px; color: var(--text-sub); display: flex; justify-content: space-between; }
.article-img-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; margin-top: 8px; display: none; }
.article-card.has-img .article-img-preview { display: block; }

/* 文章详情 */
.article-scroll-area { padding: 30px 40px; height: calc(100% - var(--header-h)); overflow-y: auto; }
#articleHeader { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
#articleHeader h1 { font-size: 24px; margin-bottom: 10px; line-height: 1.4; color: #111; }
#articleBody { font-size: 17px; line-height: 1.8; color: #333; overflow-wrap: break-word; }
#articleBody img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; display: block; }
#articleBody a { color: var(--accent); text-decoration: none; border-bottom: 1px dashed var(--accent); }
#placeholder { height: 100%; display: flex; align-items: center; justify-content: center; color: #999; flex-direction: column; gap: 15px; }

/* 移动端适配 */
@media (max-width: 768px) {
body { position: relative; }
.layout-col { position: absolute; inset: 0; width: 100%; background: #fff; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: translateX(100%); }
body[data-view="sidebar"] #sidebar { transform: translateX(0); z-index: 30; }
body[data-view="list"] #articleList { transform: translateX(0); z-index: 40; }
body[data-view="content"] #contentView { transform: translateX(0); z-index: 50; }
#sidebar, #articleList, #contentView { width: 100%; border: none; }
.article-scroll-area { padding: 20px; }
.btn-delete { opacity: 1; }
.mobile-hide { display: none; }
.mobile-show { display: inline-block; }
}
@media (min-width: 769px) { .mobile-show { display: none; } }

/* 模态框 */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal.active { display: flex; }
.modal-box { background: #fff; width: 90%; max-width: 420px; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; font-size: 18px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: #666; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; background: #fafafa; }
.form-group input:focus { border-color: var(--accent); background: #fff; }
.btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-ghost { background: #eee; color: #333; }
.tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.tag-btn { font-size: 12px; padding: 4px 8px; background: #eee; border-radius: 4px; cursor: pointer; color: #555; }
.tag-btn:hover { background: #e0e0e0; color: #000; }

/* 悬浮工具与 Loading */
#selectionToolbar { position: fixed; display: none; z-index: 2000; background: #222; color: #fff; border-radius: 6px; padding: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
#selectionToolbar button { background: none; border: none; color: #fff; padding: 4px 10px; cursor: pointer; display: flex; gap: 6px; align-items: center; font-size: 13px; }
#translatePopup { position: fixed; display: none; z-index: 2001; background: #fff; width: 300px; max-height: 300px; overflow-y: auto; padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); font-size: 14px; border: 1px solid #eee; }
.spinner { width: 24px; height: 24px; border: 3px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.cache-badge { font-size: 12px; color: #aaa; margin-left: 5px; font-weight: normal; }
</style>

</head>
<body data-view="sidebar">

<!-- 1. 订阅列表 -->

<div id="sidebar" class="layout-col">
  <div class="header-bar">
    <span data-i18n="sidebar.title">我的订阅</span>
    <div>
      <button class="btn-icon" onclick="openModal('addFeedModal')" title="添加"><i class="fa-solid fa-plus"></i></button>
      <button class="btn-icon" onclick="openModal('settingsModal')" title="设置"><i class="fa-solid fa-cog"></i></button>
    </div>
  </div>
  <div id="feedList"></div>
  <div id="loadingTips" style="text-align:center; padding:20px; color:#999; font-size:13px; display:none;" data-i18n="sidebar.loading">正在加载订阅源...</div>
</div>

<!-- 2. 文章列表 -->

<div id="articleList" class="layout-col">
  <div class="header-bar">
    <div style="display:flex; align-items:center; gap:5px; overflow:hidden;">
      <button class="btn-icon mobile-show" onclick="navTo('sidebar')"><i class="fa-solid fa-chevron-left"></i></button>
      <span id="currentFeedTitle" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" data-i18n="list.title_default">文章列表</span>
      <span id="cacheIndicator" class="cache-badge"></span>
    </div>
    <button class="btn-icon" onclick="refreshFeed()" title="强制刷新"><i class="fa-solid fa-rotate-right"></i></button>
  </div>
  <div id="listContainer" style="padding: 20px; text-align: center; color: #888;" data-i18n="list.select_tip">
    请选择左侧订阅源
  </div>
</div>

<!-- 3. 文章详情 -->

<div id="contentView" class="layout-col">
  <div class="header-bar">
    <button class="btn-icon mobile-show" onclick="navTo('list')"><i class="fa-solid fa-chevron-left"></i></button>
    <div style="flex:1"></div>
    <!-- 【新增】全文问 AI 按钮 -->
    <button class="btn-icon" onclick="actionAskAIFull(this)" style="width:auto; display:flex; align-items:center; gap:6px;">
      <i class="fa-solid fa-robot"></i>
      <!-- 这里使用 span 包裹文字，并加上 data-i18n -->
      <span data-i18n="toolbar.ask_full_ai" style="font-size:14px; font-weight:normal;">全文问AI</span>
    </button>
    <button class="btn-icon mobile-hide" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
  </div>
  <div class="article-scroll-area">
    <div id="placeholder">
      <i class="fa-solid fa-book-open" style="font-size:48px;opacity:0.3"></i>
      <div data-i18n="content.placeholder_text">选择文章开始阅读</div>
    </div>
    <div id="articleContent" style="display:none">
      <div id="articleHeader">
        <h1 id="artTitle"></h1>
        <div class="article-meta">
          <span id="artDate"></span> · 
          <a id="artLink" target="_blank"><span data-i18n="content.read_original">阅读原文</span> <i class="fa-solid fa-external-link-alt"></i></a>
        </div>
      </div>
      <div id="articleBody"></div>
    </div>
  </div>
</div>

<!-- 悬浮工具 -->

<div id="selectionToolbar">
  <button onclick="actionTranslate()"><i class="fa-solid fa-language"></i> <span data-i18n="toolbar.translate">翻译</span></button>
  <div style="width:1px;background:#555;height:14px;margin:0 2px"></div>
  <button onclick="actionAskAI()"><i class="fa-solid fa-robot"></i> <span data-i18n="toolbar.ask_ai">问 AI</span></button>
</div>
<div id="translatePopup">
  <div style="display:flex;justify-content:space-between;margin-bottom:8px;color:#888;font-size:12px">
    <span data-i18n="toolbar.translate_result">翻译结果</span><span onclick="this.parentElement.parentElement.style.display='none'" style="cursor:pointer">&times;</span>
  </div>
  <div id="translateResult"></div>
</div>

<!-- 添加订阅 Modal -->

<div id="addFeedModal" class="modal">
  <div class="modal-box">
    <div class="modal-header"><span data-i18n="modals.add_title">添加订阅</span> <span onclick="closeModal('addFeedModal')" style="cursor:pointer">&times;</span></div>

<div class="form-group"><label data-i18n="modals.url_label">URL / 路由</label>
  <input type="text" id="feedInput" placeholder="/bilibili/ranking/0/3 or rsshub://...">
</div>

<!-- [新增] 订阅名称输入框 -->

<div class="form-group">
  <label>订阅名称 (可选)</label>
  <input type="text" id="feedNameInput" placeholder="留空则自动生成 (e.g. URSB Blog)">
</div>

<div class="form-group"><label data-i18n="modals.type_label">类型</label>
  <select id="feedType">
    <option value="rsshub" data-i18n="modals.type_rsshub">RSSHub 路由</option>
    <option value="url" data-i18n="modals.type_url">普通 RSS URL</option>
  </select>
</div>
<div style="display:flex;justify-content:flex-end;gap:10px">
  <button class="btn btn-ghost" onclick="closeModal('addFeedModal')" data-i18n="modals.btn_cancel">取消</button>
  <button class="btn btn-primary" onclick="addFeed()" data-i18n="modals.btn_confirm">确认添加</button>
</div>
  </div>
</div>

<!-- 设置 Modal -->

<div id="settingsModal" class="modal">
  <div class="modal-box">
    <div class="modal-header"><span data-i18n="modals.settings_title">全局设置</span> <span onclick="closeModal('settingsModal')" style="cursor:pointer">&times;</span></div>

<!-- 界面语言 -->

<div class="form-group">
  <label data-i18n="modals.lang_label">界面语言 / Interface Language</label>
  <select id="langSelect" onchange="changeLanguage(this.value)">
    <option value="zh">简体中文</option>
    <option value="en">English</option>
  </select>
</div>

<!-- 翻译目标语言 -->

<div class="form-group">
  <label data-i18n="modals.target_lang_label">AI 翻译目标语言 / Target Language</label>
  <select id="targetLangSelect">
    <option value="Simplified Chinese">简体中文 (Simplified Chinese)</option>
    <option value="Traditional Chinese">繁体中文 (Traditional Chinese)</option>
    <option value="English">English</option>
    <option value="Japanese">Japanese</option>
    <option value="Korean">Korean</option>
    <option value="French">French</option>
    <option value="German">German</option>
    <option value="Spanish">Spanish</option>
    <option value="Russian">Russian</option>
  </select>
</div>

<div class="form-group">
  <label data-i18n="modals.hub_label">RSSHub 实例地址</label>
  <input type="text" id="rsshubUrl">
  <div class="tag-container">
    <span class="tag-btn" onclick="setHub('https://rsshub.ktachibana.party')">Ktachibana</span>
    <span class="tag-btn" onclick="setHub('https://rsshub.rssforever.com')">RssForever</span>
    <span class="tag-btn" onclick="setHub('https://rsshub.app')">Official</span>
  </div>
</div>

<div class="form-group">
  <label data-i18n="modals.cache_label">缓存有效期 (分钟)</label>
  <input type="number" id="cacheDuration" min="1" value="30">
  <div style="font-size:12px;color:#999;margin-top:5px" data-i18n="modals.cache_desc">
    间隔内再次点击不会消耗流量，直接加载本地数据。<br>点击“刷新”按钮可强制更新。
  </div>
</div>

<div style="display:flex;justify-content:flex-end;gap:10px">
  <button class="btn btn-primary" style="width:100%" onclick="saveSettings()" data-i18n="modals.btn_save">保存配置</button>
</div>
  </div>
</div>

<script>
/* ================== 配置与状态 ================== */
const CONFIG = {
  defaultHub: "https://rsshub.ktachibana.party",
  defaultCacheTime: 30,
  defaultLang: "zh"
};

let state = {
  defaultFeeds: [],
  userFeeds: [],
  allFeeds: [],
  
  settings: {
    hub: localStorage.getItem('rss_hub') || CONFIG.defaultHub,
    cacheTime: parseInt(localStorage.getItem('rss_cache_time')) || CONFIG.defaultCacheTime,
    lang: localStorage.getItem('rss_lang') || navigator.language.split('-')[0] || CONFIG.defaultLang,
    targetLang: localStorage.getItem('rss_target_lang') || "Simplified Chinese"
  },
  activeIdx: -1,
  articles: [],
  ws: null,
  cache: {},
  i18nData: {}
};

if (!['zh', 'en'].includes(state.settings.lang)) state.settings.lang = 'zh';

/* ================== 初始化 ================== */
document.addEventListener('DOMContentLoaded', async () => {
  initWS();
  loadCacheFromStorage();
  
  await initI18n();
  
  updateUI();
  document.getElementById('langSelect').value = state.settings.lang;

  await initFeeds();

  document.addEventListener('mouseup', handleSelect);
  document.addEventListener('mousedown', e => {
    if(!document.getElementById('selectionToolbar').contains(e.target)) 
      document.getElementById('selectionToolbar').style.display='none';
  });

  // 监听输入框，自动切换类型
  const feedInput = document.getElementById('feedInput');
  const feedType = document.getElementById('feedType');
  if(feedInput) {
    feedInput.addEventListener('input', (e) => {
      const val = e.target.value.trim();
      if(val.startsWith('/') || val.startsWith('rsshub://')) {
        feedType.value = 'rsshub';
      } else if(val.startsWith('http')) {
        feedType.value = 'url';
      }
    });
  }
});

/* ================== I18n 逻辑 ================== */
async function initI18n() {
  try {
    const res = await fetch('./i18n.json');
    if (res.ok) {
      state.i18nData = await res.json();
    } else {
      console.error("I18n file missing");
      state.i18nData = { zh: {}, en: {} };
    }
  } catch(e) {
    console.error("Load i18n error", e);
  }
}

function t(key) {
  const keys = key.split('.');
  let obj = state.i18nData[state.settings.lang] || {};
  for (let k of keys) {
    obj = obj[k];
    if (!obj) return key;
  }
  return obj;
}

function getTrTitle(titleField) {
  if (typeof titleField === 'object' && titleField !== null) {
    return titleField[state.settings.lang] || titleField['zh'] || titleField['en'] || "Unnamed";
  }
  return titleField; 
}

function updateUI() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    el.innerHTML = t(key); 
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el => {
    const key = el.getAttribute('data-i18n-title');
    el.setAttribute('title', t(key));
  });
  if (state.activeIdx === -1) {
    document.getElementById('currentFeedTitle').innerText = t('list.title_default');
    document.getElementById('listContainer').innerText = t('list.select_tip');
  } else {
    document.getElementById('currentFeedTitle').innerText = getTrTitle(state.allFeeds[state.activeIdx].title);
    
    const cacheBadge = document.getElementById('cacheIndicator');
    if (cacheBadge.innerText.includes(':')) {
       const timePart = cacheBadge.innerText.split(' ').pop();
       cacheBadge.innerText = `${t('list.cache_time_prefix')} ${timePart}`;
    } else if (cacheBadge.innerText) {
       cacheBadge.innerText = t('list.cache_latest');
    }
  }
  renderSidebar();
}

function changeLanguage(lang) {
  state.settings.lang = lang;
  localStorage.setItem('rss_lang', lang);
  updateUI();
}

/* ================== 订阅源逻辑 ================== */
async function initFeeds() {
  const loadingEl = document.getElementById('loadingTips');
  loadingEl.style.display = 'block';

  try {
    const res = await fetch('./default_feeds.json');
    if (res.ok) {
      state.defaultFeeds = await res.json();
      state.defaultFeeds.forEach(f => f.isDefault = true);
    }
  } catch(e) {
    state.defaultFeeds = []; 
  }

  try {
    const stored = localStorage.getItem('user_custom_feeds');
    if (stored) {
      state.userFeeds = JSON.parse(stored);
    } else {
      const old = localStorage.getItem('rss_feeds');
      if (old) state.userFeeds = JSON.parse(old);
    }
  } catch(e) {
    state.userFeeds = [];
  }

  updateAllFeeds();
  loadingEl.style.display = 'none';

  if(window.innerWidth > 768 && state.allFeeds.length) loadFeed(0);
}

function updateAllFeeds() {
  state.allFeeds = [...state.defaultFeeds, ...state.userFeeds];
  renderSidebar();
}

function saveUserFeeds() {
  localStorage.setItem('user_custom_feeds', JSON.stringify(state.userFeeds));
}

function navTo(view) { document.body.setAttribute('data-view', view); }
function openModal(id) { 
  document.getElementById(id).classList.add('active'); 
  if(id === 'settingsModal') {
    document.getElementById('rsshubUrl').value = state.settings.hub;
    document.getElementById('cacheDuration').value = state.settings.cacheTime;
    document.getElementById('targetLangSelect').value = state.settings.targetLang;
  }
  // 清空输入
  if(id === 'addFeedModal') {
      document.getElementById('feedInput').value = '';
      document.getElementById('feedNameInput').value = '';
  }
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

/* ================== 缓存与获取 ================== */

function loadCacheFromStorage() {
  try {
    const raw = localStorage.getItem('rss_cache_data');
    if(raw) state.cache = JSON.parse(raw);
  } catch(e) { state.cache = {}; }
}

function saveCacheToStorage() {
  try {
    const str = JSON.stringify(state.cache);
    if(str.length > 4 * 1024 * 1024) { 
      state.cache = {}; 
      localStorage.setItem('rss_cache_data', '{}');
    } else {
      localStorage.setItem('rss_cache_data', str);
    }
  } catch(e) {
    state.cache = {};
    localStorage.setItem('rss_cache_data', '{}');
  }
}

async function fetchRSS(feed, force) {
  let url = feed.url;
  if(feed.type === 'rsshub') {
    const hub = state.settings.hub.replace(/\/$/, '');
    url = url.startsWith('/') ? hub + url : hub + '/' + url;
  }
  const cacheKey = url;

  const cached = state.cache[cacheKey];
  const now = Date.now();
  const cacheDurationMs = state.settings.cacheTime * 60 * 1000;

  if (!force && cached && (now - cached.time < cacheDurationMs)) {
    console.log("Hit Cache:", getTrTitle(feed.title));
    return { data: cached.data, fromCache: true, time: cached.time };
  }

  const proxyApi = `/rss_proxy?url=${encodeURIComponent(url)}`;
  // [注意] 这里的 timeout 需要后端支持，前端 fetch 默认无超时或跟随浏览器
  const res = await fetch(proxyApi);
  if(!res.ok) {
    const txt = await res.text();
    throw new Error(`${t('list.error_backend')} ${res.status}: ${txt.slice(0, 100)}`);
  }
  
  const text = await res.text();
  const parser = new DOMParser();
  const xml = parser.parseFromString(text, "text/xml");
  if(xml.querySelector("parsererror")) throw new Error(t('list.error_xml'));

  let items = Array.from(xml.querySelectorAll("item"));
  if(items.length === 0) items = Array.from(xml.querySelectorAll("entry"));
  if(!items.length) throw new Error(t('list.error_empty'));

  const parsedItems = items.map(item => {
    const get = (t) => { const el = item.getElementsByTagName(t)[0]; return el ? el.textContent.trim() : ""; };
    const getLink = () => {
        const el = item.getElementsByTagName("link")[0];
        if(!el) return "";
        return el.getAttribute("href") || el.textContent.trim();
    }
    const desc = get("content:encoded") || get("description") || get("content") || get("summary");
    const img = (desc.match(/src="([^"]+)"/) || [])[1];
    let dateStr = get("pubDate") || get("published") || "";
    try { dateStr = new Date(dateStr).toLocaleString(); } catch {}

    return {
      title: get("title"),
      link: getLink(),
      desc: desc,
      date: dateStr,
      image: img
    };
  });

  state.cache[cacheKey] = { time: now, data: parsedItems };
  saveCacheToStorage();

  return { data: parsedItems, fromCache: false, time: now };
}

/* ================== UI 渲染 ================== */
function renderSidebar() {
  const list = document.getElementById('feedList');
  list.innerHTML = '';
  state.allFeeds.forEach((f, i) => {
    const div = document.createElement('div');
    div.className = `feed-item ${i === state.activeIdx ? 'active' : ''}`;
    let iconUrl = f.type === 'rsshub' ? './RSSHub_logo.png' : `https://s2.googleusercontent.com/s2/favicons?domain_url=${new URL(f.url).origin}`;
    
    const displayTitle = getTrTitle(f.title);

    let actionBtn = '';
    if (f.isDefault) {
      const lockTitle = t('alerts.default_locked');
      actionBtn = `<i class="fa-solid fa-lock icon-locked" title="${lockTitle}"></i>`;
    } else {
      const delTitle = t('alerts.delete_confirm');
      actionBtn = `<button class="btn-delete" title="${delTitle}" onclick="delFeed(${i}, event)">&times;</button>`;
    }

    div.innerHTML = `
      <img class="feed-icon" src="${iconUrl}" onerror="this.style.opacity=0">
      <div class="feed-name">${displayTitle}</div>
      ${actionBtn}
    `;
    div.onclick = () => loadFeed(i);
    list.appendChild(div);
  });
}

async function loadFeed(idx, force=false) {
  navTo('list');
  state.activeIdx = idx;
  renderSidebar();
  
  const container = document.getElementById('listContainer');
  const titleEl = document.getElementById('currentFeedTitle');
  const cacheBadge = document.getElementById('cacheIndicator');
  
  titleEl.innerText = getTrTitle(state.allFeeds[idx].title);
  cacheBadge.innerText = "";
  container.innerHTML = `<div class="spinner" style="margin-top:50px"></div><div style="margin-top:10px;color:#999;font-size:12px">${t('list.loading')}</div>`;

  try {
    const result = await fetchRSS(state.allFeeds[idx], force);
    state.articles = result.data;
    
    if(result.fromCache) {
      const date = new Date(result.time);
      cacheBadge.innerText = `${t('list.cache_time_prefix')} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')})`;
    } else {
      cacheBadge.innerText = t('list.cache_latest');
    }

    container.innerHTML = '';
    state.articles.forEach((art, i) => {
      const el = document.createElement('div');
      el.className = `article-card ${art.image?'has-img':''}`;
      el.innerHTML = `
        <div class="article-title">${art.title.replace(/</g,'&lt;')}</div>
        <div class="article-meta">${art.date}</div>
        ${art.image ? `<img src="${art.image}" class="article-img-preview" loading="lazy">` : ''}
      `;
      el.onclick = () => showArt(i, el);
      container.appendChild(el);
    });
  } catch(e) {
    container.innerHTML = `
      <div style="padding:40px;color:#f55">
        <i class="fa-solid fa-triangle-exclamation" style="font-size:24px;margin-bottom:10px"></i>
        <div>${e.message}</div>
        <div style="margin-top:20px">
           <button class="btn btn-primary" onclick="loadFeed(${idx},true)">${t('list.retry')}</button>
        </div>
      </div>`;
  }
}

function showArt(i, el) {
  navTo('content');
  document.querySelectorAll('.article-card').forEach(e=>e.classList.remove('active'));
  if(el) el.classList.add('active');
  const art = state.articles[i];
  document.getElementById('placeholder').style.display='none';
  document.getElementById('articleContent').style.display='block';
  document.getElementById('artTitle').innerText = art.title;
  document.getElementById('artDate').innerText = art.date;
  document.getElementById('artLink').href = art.link;
  document.getElementById('articleBody').innerHTML = art.desc;
  document.querySelector('.article-scroll-area').scrollTop=0;
}

/* ================== 交互逻辑 (修改版) ================== */
function addFeed() {
  let url = document.getElementById('feedInput').value.trim();
  let type = document.getElementById('feedType').value;
  let customName = document.getElementById('feedNameInput').value.trim();
  
  if(!url) return;

  // 1. 自动处理 URL 格式
  if (url.startsWith('rsshub://')) {
    type = 'rsshub';
    url = url.replace('rsshub://', '');
    if (!url.startsWith('/')) url = '/' + url;
  } 
  else if (url.startsWith('/')) {
    type = 'rsshub';
  }

  // 2. 智能命名逻辑
  let name = customName;
  if (!name) {
    if (type === 'rsshub') {
      // 策略：RSSHub 源如果只取最后一段可能为 "any" 或 "0"，尝试取更有意义的路径
      // 如 /github/trending/daily/any -> github/trending
      const parts = url.replace(/^\//, '').split('/').filter(p => p);
      if (parts.length >= 2) {
          name = parts.slice(0, 2).join('/'); 
      } else {
          name = parts[0] || "New Feed";
      }
    } else {
      // 策略：普通 URL 如果结尾是 generic name (feed.xml, rss)，则取域名
      try {
        const urlObj = new URL(url.startsWith('http') ? url : 'http://' + url);
        const filename = urlObj.pathname.split('/').pop().toLowerCase();
        const generics = ['feed', 'rss', 'atom', 'index', 'xml'];
        
        // 如果文件名包含通用词，或者文件名为空，就用域名
        if (!filename || generics.some(g => filename.includes(g))) {
          name = urlObj.hostname;
        } else {
          name = filename;
        }
      } catch(e) {
        name = "New Feed";
      }
    }
  }
  
  state.userFeeds.push({ title: name, url, type });
  saveUserFeeds(); 
  updateAllFeeds();
  
  closeModal('addFeedModal');
  loadFeed(state.allFeeds.length - 1);
}

function delFeed(i, e) {
  e.stopPropagation();
  const feed = state.allFeeds[i];
  const feedTitle = getTrTitle(feed.title);
  
  if (feed.isDefault) {
    alert(t('alerts.default_locked'));
    return;
  }

  if(confirm(`${t('alerts.delete_confirm')} "${feedTitle}" ?`)) { 
    const userIndex = i - state.defaultFeeds.length;
    
    if (userIndex >= 0) {
      state.userFeeds.splice(userIndex, 1);
      saveUserFeeds();
      updateAllFeeds();
      
      if(state.activeIdx === i) {
        document.getElementById('listContainer').innerHTML = `<div style="padding:40px;color:#999">${t('list.select_tip')}</div>`;
        state.activeIdx = -1;
      } else if (state.activeIdx > i) {
        state.activeIdx--;
      }
    }
  }
}

function fillInput(url, type) {
  document.getElementById('feedInput').value = url;
  document.getElementById('feedType').value = type;
}

function setHub(url) { document.getElementById('rsshubUrl').value = url; }

function saveSettings() {
  const oldHub = state.settings.hub;
  const newHub = document.getElementById('rsshubUrl').value.replace(/\/$/, '');
  
  state.settings.hub = newHub;
  state.settings.cacheTime = parseInt(document.getElementById('cacheDuration').value) || 30;
  state.settings.targetLang = document.getElementById('targetLangSelect').value;
  localStorage.setItem('rss_target_lang', state.settings.targetLang);
  
  localStorage.setItem('rss_hub', state.settings.hub);
  localStorage.setItem('rss_cache_time', state.settings.cacheTime);
  
  closeModal('settingsModal');
  
  if(state.activeIdx >= 0 && oldHub !== newHub) {
    loadFeed(state.activeIdx, true);
  }
}

function refreshFeed() { if(state.activeIdx>=0) loadFeed(state.activeIdx, true); }

function toggleFullScreen() {
  !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();
}

/* ================== WebSocket & AI ================== */
function initWS() {
  const proto = location.protocol==='https:'?'wss:':'ws:';
  state.ws = new WebSocket(`${proto}//${location.host}/ws`);
  state.ws.onopen = () => console.log("WS Connected");
  state.ws.onclose = () => setTimeout(initWS, 3000);
}

let selTxt = '';
function handleSelect() {
  setTimeout(() => {
    const t = window.getSelection().toString().trim();
    const bar = document.getElementById('selectionToolbar');
    if(t) {
      selTxt = t;
      const range = window.getSelection().getRangeAt(0);
      const r = range.getBoundingClientRect();
      bar.style.display = 'flex';
      let top = r.top - 45;
      let left = r.left + (r.width/2) - 50;
      if(top < 0) top = r.bottom + 10;
      bar.style.top = top + 'px';
      bar.style.left = Math.max(10, Math.min(window.innerWidth - 110, left)) + 'px';
    } else bar.style.display = 'none';
  }, 100);
}

async function actionTranslate() {
  const pop = document.getElementById('translatePopup');
  const bar = document.getElementById('selectionToolbar');
  
  // 显示弹窗，隐藏工具栏
  pop.style.display = 'block';
  pop.style.top = bar.style.top;
  pop.style.left = bar.style.left;
  bar.style.display = 'none';
  
  const resultEl = document.getElementById('translateResult');
  // 显示加载 Loading
  resultEl.innerHTML = '<div class="spinner"></div>';

  const target = state.settings.targetLang || "Simplified Chinese";

  try {
    const response = await fetch('/simple_chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [
          { role: "system", content: `Translate to ${target}.` },
          { role: "user", content: selTxt }
        ],
        stream: true // <--- 开启流式
      })
    });

    if (!response.ok) throw new Error("Network error");

    // 获取读取器
    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = '';
    let isFirstChunk = true;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      // 1. 解码当前块并追加到缓冲区
      buffer += decoder.decode(value, { stream: true });

      // 2. 按后端发送的换行符分割 (后端代码是: model_dump_json() + '\n')
      const lines = buffer.split('\n');

      // 3. 缓冲区保留最后一部分（因为它可能是不完整的 JSON，等下一个包来拼接）
      buffer = lines.pop();

      // 4. 处理完整的行
      for (const line of lines) {
        if (!line.trim()) continue;

        try {
          const json = JSON.parse(line);
          // OpenAI 流式格式通常在 choices[0].delta.content 中
          const content = json.choices?.[0]?.delta?.content || "";

          if (content) {
            // 如果是收到第一个字符，先清空 Loading 动画
            if (isFirstChunk) {
              resultEl.innerHTML = ""; 
              isFirstChunk = false;
            }
            // 追加文本
            resultEl.innerText += content;
          }
        } catch (e) {
          console.error("Stream parse error", e);
        }
      }
    }

  } catch (e) {
    console.error(e);
    resultEl.innerText = t('toolbar.translate_fail');
  }
}

function actionAskAI() {
  const title = document.getElementById('artTitle').innerText || t('list.title_default');
  
  state.ws.send(JSON.stringify({
    type: 'set_user_input', 
    data: { text: `关于文章《${title}》:\n${selTxt}` }
  }));
  
  const btn = document.querySelector('#selectionToolbar button:last-child');
  const original = btn.innerHTML;
  btn.innerHTML = `<i class="fa-solid fa-check"></i> ${t('toolbar.sent_success')}`;
  setTimeout(() => {
    btn.innerHTML = original;
    document.getElementById('selectionToolbar').style.display='none';
  }, 1000);
}
/* ================== 全文问 AI ================== */
function actionAskAIFull(btnElement) {
  // 1. 检查 WebSocket 是否连接
  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
    alert("WebSocket 未连接，请检查服务");
    return;
  }

  // 2. 检查当前是否已打开文章
  const articleContent = document.getElementById('articleContent');
  if (articleContent.style.display === 'none') {
    return; // 没有文章时不执行
  }

  // 3. 获取内容
  const title = document.getElementById('artTitle').innerText.trim();
  // 使用 innerText 可以自动去除 <p>、<img> 等标签，只保留纯文本，节省 Token
  const bodyText = document.getElementById('articleBody').innerText.trim();

  if (!bodyText) {
    alert("文章内容为空");
    return;
  }

  // 4. 组合 Prompt
  // 这里可以根据需要调整提示词，比如 "请总结这篇文章" 或 "请分析..."
  // 目前保持和选中问AI一致，只发送内容，让用户在对话框里决定怎么问
  const fullContent = `关于文章《${title}》的全文内容:\n\n${bodyText}`;

  // 5. 发送给 Electron 主窗口 / AI 侧边栏
  state.ws.send(JSON.stringify({
    type: 'set_user_input', 
    data: { text: fullContent }
  }));

  // 6. 按钮反馈动画 (变成对勾 1秒)
  const originalIcon = btnElement.innerHTML;
  btnElement.innerHTML = '<i class="fa-solid fa-check" style="color:var(--accent)"></i>';
  // 防止用户狂点，暂时禁用
  btnElement.disabled = true;
  
  setTimeout(() => {
    btnElement.innerHTML = originalIcon;
    btnElement.disabled = false;
  }, 1500);
}

/* ================== 强制新窗口打开链接 ================== */
document.addEventListener('click', function(e) {
  // 查找被点击元素是否是 A 标签，或者在 A 标签内部
  const link = e.target.closest('a');
  
  // 如果是链接，并且这是一个 http/https 的外部链接（排除掉只是锚点的情况）
  if (link && link.href && link.href.startsWith('http')) {
    // 强制设置在新标签页打开
    link.setAttribute('target', '_blank');
    
    // 如果想要更保险，也可以取消默认行为手动 open (可选)
    // e.preventDefault();
    // window.open(link.href, '_blank');
  }
}, true); // useCapture = true，确保在事件冒泡前捕获
</script>

</body>
</html>